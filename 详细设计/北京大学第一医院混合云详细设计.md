# 北京大学第一医院混合云详细设计

## 注意

本文档为贯通内部文档，不可外传。

## 目标

实现在医院内部有一份本医院相关业务功能的数据库结构及完整数据内容，而业务系统在云上的部署架构。
附带指标要求：
1. 云上与线下数据库中相同表的结构应一致。
2. 线下数据库或云与线下链路出现故障与问题时，线下数据库结构升级失败时，线上更新数据入队失败时，线上业务系统因停止服务。
3. 线下数据库的连接应使用与模拟多线程的连接方式。

## 混合云Canal客户端功能与流程说明

Canal只支持单客户端，如果要支持多客户端，那要求使用ZK，否则会出现数据错误的。
流程
1. 使用canal-client V1.1.0 版本的客户端，一直从服务端获得变更数据。
2. 每次最多只允许获得100条，防止获得过数据后客户端无法及时处理而无法及时ack后，使的数据一直重复取。
3. 如果取数据出错（不是失败），修改Redis中Key为 hybrid_cloud_canal_state 的值为 1（0-正常，1-异常）；成功的值为0；
4. 从数据库中取出要同步数据的租户列表，维护Redis中的KEY值（后期由业务代码来触发维护，现在这儿是每次循环时查询）。
    4.1. 如果一些租户已经不用同步了，请记得删除 hybrid_cloud_{租户号}_tables，hybrid_cloud_{租户号}_queue， hybrid_cloud_{租户号}_queue_ack, hybrid_cloud_{租户号}_ddl_queue， hybrid_cloud_{租户号}_queue_ddl_ack, hybrid_cloud_{租户号}_state 这四个KEY,当然队列的KEY要求里面的数据已经处理完了。
5. 从Redis中的 hybrid_cloud_{租户号}_tables 的Set结构中取出相应租户要使用的表（请在本次循环中缓存在内存中，下次循环重新取）。
6. 取得数据后，判断是否是DDL操作，如果是DDL（表结构判断的相关子令）操作
    6.1. 取表名，分别使用 desc 和 show create table 命令获得表结构与表创建语句，放到Redis中名为 hybrid_cloud_table_struct 的hase结构的KEY中。其中这个key的子key为各表的表名。
    6.2. Redis中 hybrid_cloud_db_version 值加1；
    6.3. 然后判断这个表被哪些租户 hybrid_cloud_{租户号}_tables 使用，然后把SQL语句组成结构放到租户相应的队列中 hybrid_cloud_{租户号}_ddl_queue 的列表中。
7. 如果取出来的数据，是DML数据变更操作，取变更的行，判断字段中是否有 tena_id 或 tenant_id 为结束的字段，如果没有加入到过滤表。
    7.1. 如果有 tena_id 或 tenant_id 为结束的字段，取出其中的值（租户号），然后判断租户是否要下发的（前面已取）， 如果没有，放弃本条数据。
    7.2. 如果有这租户，判断这个租户是否已经包含本表，不包含更新内存，更新 hybrid_cloud_{租户号}_tables。
    7.3. 然后把这条数据组织成协议要求的结构（随机生成一个data_id，取字段值与属性，取数据入库时间），放入到 Redis 中名为 hybrid_cloud_{租户号}_queue 的 list 列表中。
8. 如果入队列失败，调用 canal 客户端的 rollback 函数；
9. 最后判断 hybrid_cloud_{租户号}_tables 系统是否有修改，如果有修改进行数据落地，hybrid_cloud_canal_state的状态也要落地。

## 混合云服务功能说明

### 数据获取协议

流程
1. 判断租户是否要同步的租户（可通过是否存在hybrid_cloud_{租户号}_state 的 key 进行判断），如果不存在直接返回错误。
2. 如果存在，和 hybrid_cloud_db_version 中的值进行比较，如果相同从 hybrid_cloud_{租户号}_queue 取指定数量的数据，并把数据入到 hybrid_cloud_{租户号}_queue_ack 的hase结构中，key为data_id。
3. 如果不相同，包含 hybrid_cloud_db_version 不存在的情况，返回新版本（或0）给客户端。造成的问题是如果数据库没有进行过表结构变更，数据一直不会同步下去，但我们就是任性不管。

### 表结构变更语句获取协议

流程
1. 判断租户是否要同步的租户（可通过是否存在hybrid_cloud_{租户号}_state 的 key 进行判断），如果不存在直接返回错误。
2. 如果存在，从 hybrid_cloud_{租户号}_ddl_queue 取指定数量的数据，并把数据入到 hybrid_cloud_{租户号}_queue_ddl_ack 的hase结构中，key为data_id。

### 表结构接口

流程
1. 判断租户是否要同步的租户（可通过是否存在 hybrid_cloud_{租户号}_state 的 key 进行判断），如果不存在直接返回错误。
2. 如果存在，取 hybrid_cloud_{租户号}_tables 中的表，再取 hybrid_cloud_table_struct 中的数据，然后加上 hybrid_cloud_db_version 中的数据返回。
3. 如果在 hybrid_cloud_{租户号}_tables 中存在的表，但在 hybrid_cloud_table_struct 中的数据不存在时，要使用desc 和 show create table 命令获得表结构与表创建语句来补充Redis的数据。

### 数据处理结果确定

流程
1. 判断租户是否要同步的租户（可通过是否存在 hybrid_cloud_{租户号}_state 的 key 进行判断），如果不存在直接返回错误。
2. 判断数据处理类型，把已经的提交的 data_id 数据删除，如果是错误的数据，落地。
3. 正常的情况下 hybrid_cloud_{租户号}_state 的值中的状态改为 0（0-正常，1-异常），值结构为 "状态:毫秒时间戳"

### 状态与错误上报

流程
1. 判断租户是否要同步的租户（可通过是否存在 hybrid_cloud_{租户号}_state 的 key 进行判断），如果不存在直接返回错误。
2. 如果存在，数据落地，判断错误类型如果是结构升级失败、数据库连接失败，除落地外 hybrid_cloud_{租户号}_state 的值中的状态改为 1（0-正常，1-异常），值结构为 "状态:毫秒时间戳"


## 适配器功能说明

适配器以定时任务加一组线程池的方式进行操作。
流程：
1. 程序启动时判断从服务端获得数据库相关连接参数。
2. 数据库是否正常，判断 local_version 表是否存在，如果不存在新建。表结构为：
```sql
CREATE TABLE `local_version` (
  `version` int(11) NOT NULL COMMENT '版本',
  `update_time` bigint(20) NOT NULL COMMENT '升级时间,毫秒',
  `remark` varchar(128) COMMENT '描述',
  PRIMARY KEY (`version`)
) ENGINE=InnoDB COMMENT='数据库当前版本';
```
新建时，或是表记录为空时，版本为0
3. 如果数据库出错，上报服务端，并退出程序。
4. 程序启一个定时任务，每50毫秒，判断线下数据库连接情况，线下数据库情况不正常上传服务端，并停止后续操作，如果正常（以间隔3秒的样子向服务端上报状态）且前面没有表结构升级修改，把频率改为50；
5. 连接正常后，调用数据获取接口，如果返回正常则判断这数据的表是否存在，如果表不存在，那么向服务端请求这张表的表结构进行创建（要兼容重复创建失败的情况）。最后把数据并交给线程池并发执行处理，
    5.1. 插入数据操作时，如果更新字段的值为空时，使用数据入库时间做为值；
    5.2. 更新数据操作时，where条件中数据更新时间必须大于等于库中数据的更新时间，如果表中更新字段数据为空的，使用数据入库时间做为值；
6. 如果返回版本过旧时，
    6.1. 调用表结构变更语句获取协议，执行获得的变更语句，执行失败要上报。
    6.2. 调用表结构接口，获取最新的表结构列表，使用获得的最新表结构列表与线下表结构进行比较与升级，升级规格见表结构接口说明；
    6.3. 与 local_version 中插入数据，并更新内存中的值。
7. 重复第一步操作。
8. 表结构升级失败或数据库操作失败时，上传服务端，并降低定时任务频率*2，最高5秒；

升级规则见具体协议

## 认证服务功能说明

分两部分，一部分是token的认证，具体见用户服务协议文档，需要说明的是这里认证失败，要求头中 error 信息为一个 json 结果，且不再中文。
第二部分：
正常登录与正常token认证，
1. 判断租户是否要同步的租户（可通过是否存在 hybrid_cloud_{租户号}_state 的 key 进行判断），如果不是正常流程走。
2. 如果是，取 hybrid_cloud_{租户号}_state 的值。如果 hybrid_cloud_{租户号}_state 的状态是1时，认证或登录失败，如果 hybrid_cloud_{租户号}_state 的状态是0，且时间过了10秒，那么认证或登录失败。
3. 如果认证失败，正常租户 status 返回 05, 登录失败返回 07；混合云租户认证失败返回 15， 登录失败返回16，原来URL出错为08

