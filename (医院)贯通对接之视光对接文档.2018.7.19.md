# 4贯通对接之视光对接文档

描述：本规范为贯通和医院接口对接交互协议及相关的用户验证机制。

| 版本号           | 变更人员 | 变更时间       | 变更日志                              |
| :------------ | ---- | ---------- | --------------------------------- |
| V2017.07.03.0 | 陈乃共  | 2017.07.03 | 初稿                                |
| V2017.07.04.0 | 徐浩   | 2017.07.04 | 整理内容                              |
| V2017.07.05.0 | 徐浩   | 2017.07.05 | 增加排序的说明                           |
| V2017.07.05.1 | 陈乃共  | 2017.07.05 | 增加调用示例和签名说明                       |
| V2017.07.05.2 | 徐浩   | 2017.07.05 | 增加医院结构示例Sign的说明                   |
| V2017.07.10.0 | 徐浩   | 2017.07.10 | 特殊约定增加编码格式说明                      |
| V2017.07.25.0 | 陈盛帆  | 2017.07.25 | 增加验光数据查询服务                        |
| V2017.07.26.0 | 陈盛帆  | 2017.07.26 | 增加调用示例中返回的ResBusiJson参数说明         |
| V2017.08.14.0 | 陈乃共  | 2017.08.14 | 修改生成订单和订单作废的入参字段名称                |
| V2017.12.12.0 | 陈盛帆  | 2017.12.12 | 新增电子病历对接视光部分接口1100-1103           |
| V2017.12.12.1 | 陈盛帆  | 2017.12.12 | 验光信息同步接口1100，新增本次就诊id-treatmentid |
| V2017.12.19.0 | 陈盛帆  | 2017.12.19 | 验光信息同步接口1100，去除医生工号字段DocId        |
| V2018.03.26.0 | 陈乃共  | 2018.03.26 | 增加配镜单状态接口                         |
| V2018.04.10.0 | 陈乃共  | 2018.04.10 | 修改获取病人唯一标识  入参字段名称                |
| V2018.04.16.0 | 陈乃共  | 2018.04.16 | 修改订单作废入参从HIS订单改成平台订单              |
| V2018.07.19.0 | 陈乃共  | 2018.07.19 | 新增获取支付二维码接口                       |

## 特殊约定

双方的数据以JSON的格式进行交互。

调用医院的服务的时候需要使用医院的令牌服务，调用中心的服务的时候需要使用中心的令牌服务。如果一个业务需要同时调用医院及中心的服务时，需要分别调用相应的令牌再进行业务服务的调用。

交互采用UTF-8编码格式。

------



## 协议具体内容说明

### 协议介绍

| 名称     | 地址                                       | 描述                |
| ------ | ---------------------------------------- | ----------------- |
| 中心令牌服务 | [POST]ServiceIdentityZX/Api/Identity/GetToken | 中心认证接口            |
| 中心业务服务 | [POST]ServiceIdentityZX/Api/Identity/HISTrans | 业务接口，根据交易代码路由不同业务 |
| 医院令牌服务 | [POST]ServiceIdentityBY/Api/Identity/GetToken | 医院认证接口            |
| 医院业务服务 | [POST]ServiceIdentityBY/Api/Identity/HISTrans | 业务接口，根据交易代码路由不同业务 |

------

### 中心令牌获取

描述：外部系统先根据医院提供的规则获取令牌，用于验证用户的合法性。

地址：http://192.168.2.65:8000/ServiceIdentityZX/Api/Identity/GetToken

方式：POST

入参信息：

| **字段** | 类型     | **说明**    |
| ------ | ------ | --------- |
| APPID  | String | GT2017    |
| APPSEC | String | =@ddsfdsf |

```json
{
	 "APPID": "GT2017",
	 "APPSEC": "=@ddsfdsf"
}
```

出参信息

| **字段**     | 类型     | **说明**      |
| ---------- | ------ | ----------- |
| Token      | String | Token字符     |
| ExpireTime | String | 过期时间（暂时定一天） |
| IsSuccess  | String | 是否成功        |
| ErrMsg     | String | 错误信息        |

```json
{
  "Token": "sample string 1",
  "ExpireTime": "sample string 2",
  "IsSuccess": “true”,
  "ErrMsg": "sample string 4"
}
```

------



### 中心业务服务

描述：相关的中心业务流程提供统一的接口服务，通过相应的交易代码去区分业务。

地址：http://192.168.2.65:8000/ServiceIdentityZX/Api/Identity/HISTrans

方式：POST

#### 交易代码

| **交易代码** | **交易接口**   | 负责人  |
| -------- | ---------- | ---- |
| 1001     | 生成订单       | 陈乃共  |
| 1002     | 订单作废       | 陈乃共  |
| 1003     | 配镜单收费状态    | 陈乃共  |
| 1004     | 诊间结算收费     | 陈乃共  |
| 1005     | 判断可用支付方式   | 陈乃共  |
| 1006     | 获取配镜单支付二维码 | 陈乃共  |
| 1010     | 配镜单状态      | 陈乃共  |

##### 结构示例

基础入参说明

| **字段**      | 类型     | **说明**                                   |
| ----------- | ------ | ---------------------------------------- |
| TransCode   | String | 交易代码                                     |
| APPID       | String | HIS提供的系统标识号                              |
| Token       | String | 令牌                                       |
| TimeSpan    | String | 时间戳                                      |
| Sign        | String | 本次签名（格式为业务入参一级结构排序变大写+ TimeSpan+Token，具体见示例里的Sign,最终通过**MD5 32位加密**）。特别说明：排序规则根据字段的字母进行排序。比如 {'useCode': '13181','token': '123'}  经过入参排序成 TOKEN123USECODE13181。    {"request":"{'OpUser':'13181','PID':'1240705'}","pid":"1111"} 经过入参排序成 PID1111REQUEST{'OpUser':'13181','PID':'1240705'}。 |
| ReqBusiJson | String | 业务入参字符串（JSON格式）                          |

```json
{
  "TransCode": "1000",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "COMPANYCODE温州医科大学附属眼视光医院SYSTYPECODEPACS2016TOKEN123USECODE131812017523EF658E8CE6DBA9AA4F948938E20A5",
  "ReqBusiJson": "{'useCode': '13181','token': '123','sysTypeCode': 'PACS2016','companyCode': '温州医科大学附属眼视光医院'}"
}
```

基础出参说明

| **字段**      | 类型     | **说明**          |
| ----------- | ------ | --------------- |
| ResBusiJson | String | 业务出参字符串（json格式） |
| ErrMsg      | String | 服务错误信息          |
| IsSuccess   | String | 服务是否成功          |

```json
{
  "IsSuccess":"false",
  "ErrMsg":"token过期，请重新生成",
  "ResBusiJson":""
}
```
**注：ResBusiJson参数为实际业务返回数据，具体内容参考各个协议后面的出参说明**





#### 1.生成订单

描述：平台生成配镜单后，同步订单信息到医院订单层。

入参信息

| 参数名      | 类型     | 说明    |
| -------- | ------ | ----- |
| PID      | String | 病人id  |
| OpUser   | String | 操作人工号 |
| OpDept   | String | 操作部门号 |
| ItemList | List   | 明细列表  |

明细ItemList 信息

| 参数名     | 类型     | 说明     |
| ------- | ------ | ------ |
| ItemNum | String | 配镜单数量  |
| Price   | String | 价格     |
| ExtKey  | String | 配镜单号   |
| DocID   | String | 开单医生编号 |
| DocDept | String | 开单部门编号 |
| ItemID  | String | 项目编号   |

```json
{
  "TransCode": "1001",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"request\":\"{'OpUser':'13181','PID':'1240705','OpDept':'001','ItemList': [{\'ItemNum\':\'3\',\'Price\':\'20\',\'ExtKey\':\'10001\',\'DocID\':\'13181\',\'DocDept\':\'001\',\'ItemID\':\'12\'}] }\"}"
}
```

返回信息

| 参数名          | 类型     | 说明     |
| ------------ | ------ | ------ |
| IsSuccess    | String | 业务是否成功 |
| ErrMsg       | String | 业务错误信息 |
| OrderMsgList | List   | 明细列表   |

明细OrderMsgList信息

| 参数名      | 类型     | 说明     |
| -------- | ------ | ------ |
| ExtKeyID | String | 平台配镜单号 |
| OrderNo  | String | 订单号    |

```json
{
  "IsSuccess":"true",
  "ErrMsg":"",
  "ResBusiJson":"{\"OrderMsgList\":[{\"ExtKeyID\":\"10001\",\"OrderNo\":\"1\" }],\"IsSuccess\":true,\"ErrMsg\":null}"
}
```

#### 2.订单作废

描述:平台在作废配镜单的时候，通知医院作废配镜单

入参信息

| 参数名    | 类型     | 说明     |
| ------ | ------ | ------ |
| OpUser | String | 操作人工号  |
| OpDept | String | 操作部门   |
| ExtKey | String | 平台配镜单号 |

```json
{
  "TransCode": "1002",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"request\":\"{'OpUser':'13181','OpDept':'001','ExtKey':'1'}\"}"
}
```

出参信息

| 参数名       | 类型     | 说明     |
| --------- | ------ | ------ |
| IsSuccess | String | 业务是否成功 |
| ErrMsg    | String | 业务错误信息 |

```json
{
"IsSuccess":"true",
"ErrMsg":"",
"ResBusiJson":"
	{
		\"IsSuccess\":true,
		\"ErrMsg\":null
	}"
}
```

#### 3.配镜单收费状态

描述：平台可以发起查询，查询配镜单的收费状态

入参信息

| 参数名    | 类型     | 说明   |
| ------ | ------ | ---- |
| saleID | String | 配镜单号 |

```json
{
  "TransCode": "1003",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"saleID\":\"10001\"}"
}
```

出参信息

| 参数名   | 类型     | 说明   |
| ----- | ------ | ---- |
| 直接返回值 | String | 是否收费 |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"false"
}
```

#### 4.诊间结算收费

描述：平台在销售的时候可以直接进行诊间结算扣款 

入参信息

| 参数名          | 类型      | 说明    |
| ------------ | ------- | ----- |
| PID          | String  | 病人id  |
| SaleRecordID | String  | 配镜单号  |
| PayType      | String  | 支付方式  |
| Money        | String  | 价格    |
| Session      | Session | 操作员信息 |

Session对象信息

| 参数名      | 类型     | 说明    |
| -------- | ------ | ----- |
| DeptCode | String | 部门编号  |
| DeptName | String | 部门名称  |
| UserCode | String | 操作员编号 |
| UserName | String | 操作员名称 |

```json
{
  "TransCode": "1004",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"request\":\"{'PID':'1240705','SaleRecordID':'10001','PayType':'1','Money':'10','Session': {\'DeptCode\':\'003\',\'DeptName\':\'视光\',\'UserCode\':\'13181\',\'UserName\':\'cng\'} }\"}"
}
```

出参信息

| 参数名       | 类型     | 说明     |
| --------- | ------ | ------ |
| IsSuccess | String | 业务是否成功 |
| ErrorInfo | String | 业务错误信息 |

```json
{"IsSuccess":true,"ErrMsg":"","ResBusiJson":"{\"IsSuccess\":false,\"ErrorInfo\":\"支付失败,眼镜收费服务无法以现金方式收取费用。\"}"}
```

#### 5.判断可用支付方式 

描述：平台生成配镜单后，先判断是会否有可用的支付方式，有的话可以直接进行诊间结算。

入参信息

| 参数名      | 类型     | 说明    |
| -------- | ------ | ----- |
| PID      | String | 病人id  |
| SumMoney | String | 配镜单金额 |

```json
{
  "TransCode": "1005",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"request\":\"{'Summoney':'0','PID':'1240705'}\"}"
}
```

出参信息

| 参数名       | 类型     | 说明     |
| --------- | ------ | ------ |
| IsSuccess | String | 业务是否成功 |
| ErrorInfo | String | 业务错误信息 |
| PayType   | String | 明细列表   |

```json
{
  "IsSuccess":true,
 "ErrMsg":"",
 "ResBusiJson":"{\"PayType\":1,\"IsSuccess\":true,\"ErrorInfo\":null}"
}
```

------

#### 6.配镜单状态

描述：平台可以发起查询，查询配镜单的收费状态

入参信息

| 参数名    | 类型     | 说明   |
| ------ | ------ | ---- |
| saleID | String | 配镜单号 |

```json
{
  "TransCode": "1010",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"saleID\":\"10001\"}"
}
```

出参信息

| 参数名   | 类型   | 说明                            |
| ----- | ---- | ----------------------------- |
| 直接返回值 | Int  | 是否收费(待收费=1,已收费=3,已取消=4,已退费=6) |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"1"
}
```

#### 7.获取支付二维码

 描述：获取微信和支付宝的支付二维码

入参信息

|    参数名    |  类型  |                         说明                        |
|--------------|--------|-----------------------------------------------------|
| DeptId       | String | 开单科室代码                                        |
| DeptName     | String | 开单科室名称                                        |
| DoctorId     | String | 开单医生代码，工号                                  |
| DoctorName   | String | 开单医生名称                                        |
| ClinicTime   | String | 就诊时间                                            |
| PatientId    | String | 病历号，PID                                         |
| PatientName  | String | 患者姓名                                            |
| HealthCardNo | String | 健康卡号，PID                                       |
| SaleID       | int    | 配镜单号                                            |
| SaleType     | int    | 配镜单类别 1 表示研究院 2 表示中心系统，盼盼视界：2 |

```json
{
  "TransCode": "1006",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"request\":\"{'DeptId':'001','DeptName':'普通科室','DoctorId':'13181','DoctorName': '张三','ClinicTime': '2018-1-1 11:00','PatientId': '123','PatientName': '李四','HealthCardNo': '123','SaleID': 123,'SaleType': 1 }\"}"
 }
```

出参信息

|  参数名   |  类型  |     说明     |
|-----------|--------|--------------|
| QRList    | List   | 二维码列表   |
| IsSuccess | String | 业务是否成功 |
| ErrMsg    | String | 业务错误信息 |

明细QRList信息

|   参数名    |  类型  |            说明           |
|-------------|--------|---------------------------|
| QrType      | String | 二维码类别（微信 支付宝） |
| QrUrl       | String | 二维码Url                 |
| ExpireTimes | String | 过期时间，毫秒            |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"IsSuccess\":true,\"ErrorInfo\":\"\",\"QRList\":\"[{\'QrType\':\'微信\',\'QrUrl\':\'http://www.baidu.com\',\'ExpireTimes\':\'10\'}]\"}"
}
```

## 

### 医院令牌获取

描述：外部系统先根据医院提供的规则获取令牌，用于验证用户的合法性。

地址：http://192.168.2.65:8000/ServiceIdentityBY/Api/Identity/GetToken

方式：POST

入参信息：

| **字段** | 类型     | **说明**    |
| ------ | ------ | --------- |
| APPID  | String | GT2017    |
| APPSEC | String | =@ddsfdsf |

```json
{
	 "APPID": "GT2017",
	 "APPSEC": "=@ddsfdsf"
}
```

出参信息

| **字段**     | 类型     | **说明**      |
| ---------- | ------ | ----------- |
| Token      | String | Token字符     |
| ExpireTime | String | 过期时间（暂时定一天） |
| IsSuccess  | String | 是否成功        |
| ErrMsg     | String | 错误信息        |

```json
{
  "Token": "sample string 1",
  "ExpireTime": "sample string 2",
  "IsSuccess": “true”,
  "ErrMsg": "sample string 4"
}
```

------



### 医院业务服务

描述：相关的医院业务流程提供统一的接口服务，通过相应的交易代码去区分业务。

地址：http://192.168.2.65:8000/ServiceIdentityBY/Api/Identity/HISTrans

方式：POST

#### 交易代码

| **交易代码**  | **交易接口**        | 负责人  |
| --------- | --------------- | ---- |
| 1006      | 当日是否有收视光矫正费     | 黄昌可  |
| 1007      | 获取病人唯一标识        | 余泽   |
| 1008      | 获取病人验光记录        | 陈盛帆  |
| 1009      | 获取验光详细数据        | 陈盛帆  |
| 1100      | 验光信息同步          | 陈盛帆  |
| 1101（已作废） | 查询老系统病人待收费配镜单   | 陈盛帆  |
| 1102（已作废） | 查询老系统病人已收费配镜单   | 陈盛帆  |
| 1103（已作废） | 根据配镜单号查询配镜单详细信息 | 陈盛帆  |
| 1011      | 获取支付二维码         | 陈乃共  |

##### 结构示例

基础入参说明

| **字段**      | 类型     | **说明**                                   |
| ----------- | ------ | ---------------------------------------- |
| TransCode   | String | 交易代码                                     |
| APPID       | String | HIS提供的系统标识号                              |
| Token       | String | 令牌                                       |
| TimeSpan    | String | 时间戳                                      |
| Sign        | String | 本次签名（格式为业务入参一级结构排序变大写+ TimeSpan+Token，具体见示例里的Sign,最终通过**MD5 32位加密**）。特别说明：排序规则根据字段的字母进行排序。比如 {'useCode': '13181','token': '123'}  经过入参排序成 TOKEN123USECODE13181。    {"request":"{'OpUser':'13181','PID':'1240705'}","pid":"1111"} 经过入参排序成 PID1111REQUEST{'OpUser':'13181','PID':'1240705'}。 |
| ReqBusiJson | String | 业务入参字符串（JSON格式）                          |

```json
{
  "TransCode": "1000",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "COMPANYCODE温州医科大学附属眼视光医院SYSTYPECODEPACS2016TOKEN123USECODE131812017523EF658E8CE6DBA9AA4F948938E20A5",
  "ReqBusiJson": "{'useCode': '13181','token': '123','sysTypeCode': 'PACS2016','companyCode': '温州医科大学附属眼视光医院'}"
}
```

基础出参说明

| **字段**      | 类型     | **说明**          |
| ----------- | ------ | --------------- |
| ResBusiJson | String | 业务出参字符串（json格式） |
| ErrMsg      | String | 服务错误信息          |
| IsSuccess   | String | 服务是否成功          |

```json
{
  "IsSuccess":"false",
  "ErrMsg":"token过期，请重新生成",
  "ResBusiJson":{}
}
```

------

#### 1.当日是否有收视光矫正费

描述：平台在开配镜单的时候，需要知道该病人当日是否有交视光矫正费.

入参信息

| 参数名      | 类型     | 说明      |
| -------- | ------ | ------- |
| PID      | String | 病人唯一主索引 |
| itemCode | String | 项目编号    |

```json
{
  "TransCode": "1006",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign":"业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\”pid\”: \”1240705\”, \”itemCode\”: \”2037\”}"
}
```

出参信息

| 参数名       | 类型     | 说明     |
| --------- | ------ | :----- |
| IsSuccess | String | 业务是否成功 |
| ErrorInfo | String | 业务错误信息 |
| IsCharged | String | 是否已收   |
| Money     | String | 金额     |

```json
{
  "IsSuccess":true,"ErrMsg":"","ResBusiJson":"{\"IsCharged\":false,\"Money\":0.0,\"IsSuccess\":true,\"ErrorInfo\":\" \"}"
}
```



#### 2.获取病人唯一标识

 描述：平台在病人刷卡后，根据硬件读卡读出来的卡号，调用医院接口，获取病人唯一标识

入参信息

| 参数名        | 类型     | 说明           |
| ---------- | ------ | ------------ |
| CardNo     | String | 卡号           |
| CardTypeID | String | 磁条卡-1  芯片卡-3 |

```json
{
  "TransCode": "1007",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"request\":\"{'CardNo':'00040108220442184536','CardTypeID':'1'}\"}"
 }
```

出参信息

| 参数名           | 类型     | 说明     |
| ------------- | ------ | ------ |
| PID           | String | 病人唯一索引 |
| ResultCode    | String | 业务是否成功 |
| ResultMessage | String | 业务错误信息 |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"ResultCode\":1,\"ResultMessage\":\"\",\"pid\":2978}"
}
```



#### 3.获取病人验光记录

 描述：平台的销售界面在病人刷卡后，根据病人的pid获取his端病人的所有验光记录

入参信息

| 参数名  | 类型     | 说明   |
| ---- | ------ | ---- |
| pid  | String | 病人id |

```json
{
  "TransCode": "1008",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"pid\": \"1240705\"}"
 }
```

出参信息

| 参数名       | 类型     | 说明           |
| --------- | ------ | ------------ |
| Data      | String | 业务数据，即验光记录列表 |
| IsSuccess | String | 业务是否成功       |
| ErrorInfo | String | 业务错误信息       |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"IsSuccess\":true,\"ErrorInfo\":\"\",\"Data\":}"
}
```

Data数据说明

| 参数名        | 类型     | 说明   |
| ---------- | ------ | ---- |
| Pid        | int    | 病人id |
| ReportDate | string | 验光日期 |
| RefID      | string | 验光id |



#### 4.获取病人详细验光数据

 描述：平台的销售界面在选择病人的验光记录后，根据该验光记录的id查询详细验光数据、处方

入参信息

| 参数名   | 类型     | 说明   |
| ----- | ------ | ---- |
| refID | String | 验光id |

```json
{
  "TransCode": "1009",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"refID\": \"1490386\"}"
 }
```

出参信息

| 参数名       | 类型     | 说明         |
| --------- | ------ | ---------- |
| Data      | String | 业务数据，即验光数据 |
| IsSuccess | String | 业务是否成功     |
| ErrorInfo | String | 业务错误信息     |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"IsSuccess\":true,\"ErrorInfo\":\"\",\"Data\":}"
}
```

Data数据说明



#### 5.验光信息同步

 描述：医生保存病人验光信息后，同步到医院库

入参信息

| 字段名称           | 字段类型   | 含义        |
| -------------- | ------ | --------- |
| Checkuser      | String | 验光人       |
| Checkdate      | String | 验光时间      |
| Vod            | Double | 右眼视力      |
| Vos            | Double | 左眼视力      |
| Vchecker       | String | 验光员工号     |
| Autosod        | Double | 电脑验光右眼球镜  |
| Autohod        | Double | 电脑验光右眼柱镜  |
| Autoaod        | Double | 电脑验光右眼轴向  |
| Automemood     | String | 电脑验光右眼备注  |
| Autosos        | Double | 电脑验光左眼球镜  |
| Autohos        | Double | 电脑验光左眼柱镜  |
| Autoaos        | Double | 电脑验光左眼轴向  |
| Automemoos     | String | 电脑验光左眼备注  |
| Autochecker    | String | 电脑验光员工号   |
| Pdd            | Double | 远用瞳距      |
| Pdn            | Double | 近用瞳距      |
| Ph             | Double | 瞳高        |
| Pmemo          | String | 瞳距瞳高备注    |
| Pdchecker      | String | 瞳距记录员工号   |
| Subsod         | Double | 主觉验光右眼球镜  |
| Subhod         | Double | 主觉验光右眼柱镜  |
| Subaod         | Double | 主觉验光右眼轴向  |
| Subvod         | Double | 主觉验光右眼视力  |
| Subpod         | String | 主觉验光右眼棱镜  |
| Submemood      | String | 主觉验光右眼备注  |
| Subsos         | Double | 主觉验光左眼球镜  |
| Subhos         | Double | 主觉验光左眼柱镜  |
| Subaos         | Double | 主觉验光左眼轴向  |
| Subvos         | Double | 主觉验光左眼视力  |
| Subpos         | String | 主觉验光左眼棱镜  |
| Submemoos      | String | 主觉验光左眼备注  |
| Subchecker     | String | 主觉验光员工号   |
| Retisod        | Double | 检影验光右眼球镜  |
| Retihod        | Double | 检影验光右眼柱镜  |
| Retiaod        | Double | 检影验光右眼轴向  |
| Retivod        | Double | 检影验光右眼视力  |
| Retimemood     | String | 检影验光右眼备注  |
| Retisos        | Double | 检影验光左眼球镜  |
| Retihos        | Double | 检影验光左眼柱镜  |
| Retiaos        | Double | 检影验光左眼轴向  |
| Retivos        | Double | 检影验光左眼视力  |
| Retimemoos     | String | 检影验光左眼备注  |
| Retichecker    | String | 检影验光员工号   |
| Add            | Double | 近附加       |
| Addchecker     | String | 近附加记录员工号  |
| Dispnsod       | Double | 右眼球镜近用处方  |
| Dispnhod       | Double | 右眼柱镜近用处方  |
| Dispnaod       | Double | 右眼轴向近用处方  |
| Dispnvod       | Double | 右眼视力近用处方  |
| Dispnpod       | String | 右眼棱镜近用处方  |
| Dispnmemood    | String | 右眼备注近用处方  |
| Dispnsos       | Double | 左眼球镜近用处方  |
| Dispnhos       | Double | 左眼柱镜近用处方  |
| Dispnaos       | Double | 左眼轴向近用处方  |
| Dispnvos       | Double | 左眼视力近用处方  |
| Dispnpos       | String | 左眼棱镜近用处方  |
| Dispnmemoos    | String | 左眼备注近用处方  |
| Dispndoctor    | String | 近用处方医生员工号 |
| Dispdsod       | Double | 右眼球镜远用处方  |
| Dispdhod       | Double | 右眼柱镜远用处方  |
| Dispdaod       | Double | 右眼轴向远用处方  |
| Dispdvod       | Double | 右眼视力远用处方  |
| Dispdpod       | String | 右眼棱镜远用处方  |
| Dispdmemood    | String | 右眼备注远用处方  |
| Dispdsos       | Double | 左眼球镜远用处方  |
| Dispdhos       | Double | 左眼柱镜远用处方  |
| Dispdaos       | Double | 左眼轴向远用处方  |
| Dispdvos       | Double | 左眼视力远用处方  |
| Dispdpos       | String | 左眼棱镜远用处方  |
| Dispdmemoos    | String | 左眼备注远用处方  |
| Dispddoctor    | String | 近用处方医生员工号 |
| Clbcod         | Double | 隐形眼镜右眼BC  |
| Cldiaod        | Double | 隐形眼镜右眼Dia |
| Clkod          | String | 隐形眼镜右眼K   |
| Clbcos         | Double | 隐形眼镜左眼BC  |
| Cldiaos        | Double | 隐形眼镜左眼Dia |
| Clkos          | String | 隐形眼镜左眼K   |
| Clsos          | Double | 隐形左眼球镜    |
| Clhos          | Double | 隐形左眼柱镜    |
| Claos          | Double | 隐形左眼轴向    |
| Clsod          | Double | 隐形右眼球镜    |
| Clhod          | Double | 隐形右眼柱镜    |
| Claod          | Double | 隐形右眼轴向    |
| Clmemood       | String | 隐形右眼备注    |
| Clmemoos       | String | 隐形左眼备注    |
| Cldoctor       | String | 隐形处方记录员工号 |
| OtherOptometry | String | 其他处方      |
| Otherdoctor    | String | 其他处方医生工号  |
| DocDeptId      | String | 开单部门编号    |
| TreatmentId    | string | 本次就诊编号    |

```json
{
  "TransCode": "1009",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"refID\": \"1490386\"}"
 }
```

出参信息

| 参数名       | 类型     | 说明     |
| --------- | ------ | ------ |
| IsSuccess | String | 业务是否成功 |
| ErrorInfo | String | 业务错误信息 |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
}
```



#### 6.查询病人待收费配镜单列表

 描述：电子病历历史记录中需要显示病人历史所有待收费配镜单

入参信息

| 参数名  | 类型     | 说明   |
| ---- | ------ | ---- |
| pid  | String | 病人id |

```json
{
  "TransCode": "1009",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"pid\": \"1490386\"}"
 }
```

出参信息

| 参数名       | 类型     | 说明             |
| --------- | ------ | -------------- |
| Data      | String | 业务数据，即待收费配镜单列表 |
| IsSuccess | String | 业务是否成功         |
| ErrorInfo | String | 业务错误信息         |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"IsSuccess\":true,\"ErrorInfo\":\"\",\"Data\":}"
}
```

Data数据说明

| 参数名          | 类型     | 说明    |
| ------------ | ------ | ----- |
| SaleRecordID | string | 配镜单号  |
| SaleDate     | Date   | 开单时间  |
| DBType       | int    | 所属数据库 |



#### 7.查询病人已收费配镜单列表

 描述：电子病历历史记录中需要显示病人历史所有已收费配镜单

入参信息

| 参数名  | 类型     | 说明   |
| ---- | ------ | ---- |
| pid  | String | 病人id |

```json
{
  "TransCode": "1009",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"pid\": \"1490386\"}"
 }
```

出参信息

| 参数名       | 类型     | 说明             |
| --------- | ------ | -------------- |
| Data      | String | 业务数据，即已收费配镜单列表 |
| IsSuccess | String | 业务是否成功         |
| ErrorInfo | String | 业务错误信息         |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"IsSuccess\":true,\"ErrorInfo\":\"\",\"Data\":}"
}
```

Data数据说明

| 参数名          | 类型     | 说明    |
| ------------ | ------ | ----- |
| SaleRecordID | string | 配镜单号  |
| ChargeDate   | Date   | 收费时间  |
| DBType       | int    | 所属数据库 |



#### 8.查询病人配镜单明细

 描述：电子病历历史记录中点击配镜单时需要显示改配镜单的明细

入参信息

| 参数名          | 类型     | 说明    |
| ------------ | ------ | ----- |
| SaleRecordID | String | 配镜单号  |
| DBType       | int    | 所属数据库 |

```json
{
  "TransCode": "1009",
  "APPID": "GT2017",
  "Token": "523EF658E8CE6DBA9AA4F948938E20A5",
  "TimeSpan": "2017",
  "Sign": "业务入参排序+ TimeSpan+Token",
  "ReqBusiJson": "{\"SaleRecordID\": \"1490386\"，\"DBType\": \"1\"}"
 }
```

出参信息

| 参数名       | 类型     | 说明            |
| --------- | ------ | ------------- |
| Data      | String | 业务数据，即配镜单明细列表 |
| IsSuccess | String | 业务是否成功        |
| ErrorInfo | String | 业务错误信息        |

```json
{
  "IsSuccess":true,
  "ErrMsg":"",
  "ResBusiJson":"{\"IsSuccess\":true,\"ErrorInfo\":\"\",\"Data\":}"
}
```

Data数据说明

| 参数名         | 类型     | 说明   |
| ----------- | ------ | ---- |
| ProductName | string | 商品名字 |
| UnitPrice   | string | 售价单价 |
| Number      | string | 数量   |
| TotalPrice  | string | 实收金额 |
| Comment     | string | 备注   |

## 调用示例

C#版本    


       public string HttpPost(string url, string body)
       { 
           try
            {
                Encoding encoding = Encoding.UTF8;
                HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);
                request.Method = "POST";
                request.ContentType = "application/json";
    
                byte[] buffer = encoding.GetBytes(body);
                request.ContentLength = buffer.Length;
                request.GetRequestStream().Write(buffer, 0, buffer.Length);
                HttpWebResponse response = (HttpWebResponse)request.GetResponse();
                using (StreamReader reader = new StreamReader(response.GetResponseStream(), Encoding.UTF8))
                {
                    return reader.ReadToEnd();
                }
            }
            catch (WebException e)
            {
                HttpWebResponse rtn = e.Response as HttpWebResponse;
                using (StreamReader reader = new StreamReader(rtn.GetResponseStream(), Encoding.UTF8))
                {
                    throw new Exception(reader.ReadToEnd());
                }
                
            }
        }




