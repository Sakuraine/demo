# 基础服务

## 概述

用于获取流水号和各种ID单个/批量生成

流水号主要包括：全局流水号/一天的流水号/一天的流水号（带前缀）返回String型/一天的流水号（带前缀）返回long型/租户内永不重复的流水号。

ID类型主要包括：租户ID/医护用户ID/请求操作ID/全平台不重复ID/文件资源记录ID/医护账号ID/患者用户ID/患者账号ID/开发账号ID/租户管理员ID/科室部门ID

前身为加解密服务，负责主密钥的存储，数据密钥的生成，然后对数据使用数据密钥进行加解密。
然后在这些功能的基础上添加了对关键数据进行管理的功能。

## 功能描述

### 数据密钥

数据密钥最多为31个，密钥用途分为三类：1：证件号，3：手机号，9：其它。基本1和3的密钥分别有且只有一份。
数据密钥的明文，使用密钥创建时间加代码中的一段特定信息组成的密钥串进行随机加密算法的加密，加密结果存储在数据库中。
在程序初始化时，会随机生成五个数据密钥，一个加密证件，一个加密银行卡号，一个加密手机号，二个为其它用途。

### 关键加密数据

关键加密数据，包含OSS、云片、数据库连接密码等关键类信息，他们被数据密钥进行随机的加密，然后存储在数据库中。

## 版本

| 架包             | 版本             | Group      |
| -------------- | -------------- | ---------- |
| core-interface | 0.1.0-SNAPSHOT | com.seeing |

## 配置文件

配置参数

| 参数                                   | 说明                 |
| ------------------------------------ | ------------------ |
| rpc.remote.address.com.seeing.id     | RPC客户需要的配置，指明服务端地址 |
| rpc.remote.address.com.seeing.kms    | RPC客户需要的配置，指明服务端地址 |
| rpc.remote.address.com.seeing.notify | RPC客户需要的配置，指明服务端地址 |

## 流水号生成

### 调用接口

```java
com.seeing.id
```

#### 调用接口方法（SerialGain）

```java
@Autowired
private SerialObtain serialObtain;
```

##### 获取销售流水号

```java
String salesOrderNo(Long tenantID) throws Exception;
```

##### 获取退货流水号

```java
String returnOrderNo(Long tenantID) throws Exception;
```

##### 获取调拨流水号

```java
String allocationNo(Long tenantID) throws Exception;
```

##### 获取促销流水号

```java
String promoteOrderNo(Long tenantID) throws Exception;
```

##### 获取调价流水号

```java
String adjustPriceNo(Long tenantID) throws Exception;
```

##### 获取入库流水号

```java
String inDepotNo(Long tenantID) throws Exception;
```

##### 获取出库流水号

```java
String outDepotNo(Long tenantID) throws Exception;
```

##### 获取采购流水号

```java
String purchaseNo(Long tenantID) throws Exception;
```

##### 获取到货单流水号

```java
String goodsArrivalNo(Long tenantID) throws Exception;
```

##### 获取制镜单流水号

```java
String glassProcessNo(Long tenantID) throws Exception;
```

##### 获取盘点单流水号

```java
String depotInventoryNo(Long tenantID) throws Exception;
```

##### 获取销售退货单流水号

```java
String saleReturnNo(Long tenantID) throws Exception;
```

##### 获取库存退货单流水号

```java
String stockReturnNo(Long tenantID) throws Exception;
```

##### 获取磨镜报损单流水号

```java
String glassesBadNo(Long tenantID) throws Exception;
```

#### 调用接口方法（SerialObtain）

```java
@Autowired
private SerialObtain serialObtain;
或者
SerialObtain serialObtain = RpcProxy.create(SerialObtain.class);
```

##### 获取租户内的当天的订单流水号

```java
String orderSerialNumberByDay(String flag, long tenantId, int serialSize) throws Exception;
```
例如：
销售：
XS+日期（171218）+4位自增数字
入库：
RK+日期（171218）+4位自增数字
调拨：
DB+日期（171218）+4位自增数字

入参：

| 参数         | 说明           |
| ---------- | ------------ |
| flag       | 标志（XS,RK,DB） |
| tenantId   | 租户号          |
| serialSize | 自增数字的位数      |


##### 获取全局流水号

```java
long globalSerialNumber(String flag) throws Exception;
```

入参：

| 参数   | 说明   |
| ---- | ---- |
| flag | 标志   |

##### 获取全局流水号

```java
long serialNumberByDay(String flag, long tenantId) throws Exception;
```

入参：

| 参数       | 说明   |
| -------- | ---- |
| flag     | 标志   |
| tenantId | 租户号  |

##### 获取一天的流水号（带前缀）返回String型

```java
String serialNumberPrefixByDay(String flag, long tenantId, String prefix, int serialSize) throws Exception;
```

入参：

| 参数         | 说明        |
| ---------- | --------- |
| flag       | 标志        |
| tenantId   | 租户号       |
| prefix     | 流水号前缀     |
| serialSize | 流水号长度，0补位 |

##### 获取一天的流水号（带前缀）返回long型

```java
long serialNumberDigitPrefixByDay(String flag, long tenantId, int prefix, int serialSize) throws Exception;
```

入参：

| 参数         | 说明        |
| ---------- | --------- |
| flag       | 标志        |
| tenantId   | 租户号       |
| prefix     | 流水号前缀     |
| serialSize | 流水号长度，0补位 |

##### 获取租户内永不重复的流水号

```java
long globalSerialNumber(String flag, long tenantId) throws Exception;
```

入参：

| 参数       | 说明   |
| -------- | ---- |
| flag     | 标志   |
| tenantId | 租户号  |

## ID生成

### 调用接口

```java
com.seeing.id
```

#### 调用接口方法（IDService）

```java
@Autowired
private IDService idService;
或者
IDService idService = RpcProxy.create(IDService.class);
```

#####获得一个新的ID（ID类型自己参数选择）

```java
long getNextId(int idType);
```

入参：

| 参数     | 说明                                       |
| ------ | ---------------------------------------- |
| idType | 需要获取的ID类型（常量类在com.seeing.id.bean.IDType中） |

##### 批量获取ID（ID类型自己参数选择）

```java
List<Long> getBatchIds(int idType, int count);
```

入参：

| 参数     | 说明                                       |
| ------ | ---------------------------------------- |
| idType | 需要获取的ID类型（常量类在com.seeing.id.bean.IDType中） |
| count  | 批量获取的数量                                  |

#### 调用实现类方法（Order）

```java
@Autowired
private Order order;
```

##### 获取租户ID（单个/批量）

```java
long id = order.getTenantId();
List<Long> ids = order.getTenantIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取医护用户ID（单个/批量）

```java
long id = order.getMedicalUserId();
List<Long> ids = order.getMedicalUserIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取请求操作ID（单个/批量）

```java
long id = order.getRequestId();
List<Long> ids = order.getRequestIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取全平台不重复ID（单个/批量）

```java
long id = order.getUniqueId();
List<Long> ids = order.getUniqueIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取文件资源记录ID（单个/批量）

```java
long id = order.getFileResourceId();
List<Long> ids = order.getFileResourceIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取医护账号ID（单个/批量）

```java
long id = order.getMedicalAccountId();
List<Long> ids = order.getMedicalAccountIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取患者用户ID（单个/批量）

```java
long id = order.getPatientUserId();
List<Long> ids = order.getPatientUserIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取患者账号ID（单个/批量）

```java
long id = order.getPatientAccountId();
List<Long> ids = order.getPatientAccountIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取开发账号ID（单个/批量）

```java
long id = order.getDevelopId();
List<Long> ids = order.getDevelopIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取租户管理员ID（单个/批量）

```java
long id = order.getTenantAdminId();
List<Long> ids = order.getTenantAdminIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取科室部门ID（单个/批量）

```java
long id = order.getDepartementId();
List<Long> ids = order.getDepartementIdList(int count);
```

| 参数    | 说明      |
| ----- | ------- |
| count | 批量获取的数量 |

##### 获取订单ID（单个）

```java
long id = order.getTradeId();
```

## KMS

### 数据加密

```java
String encryptData(String data, Integer dataType) throws SeeingException;
String encryptData(byte[] data, Integer dataType) throws SeeingException;
String encryptData(byte[] data) throws SeeingException; // 数据类型默认为9
String encryptData(String data) throws SeeingException; // 数据类型默认为9
```

#### 入参说明

| 参数名      | 必填   | 类型            | 说明                   |
| -------- | ---- | ------------- | -------------------- |
| content  | 是    | String或Byte[] | 要加密的数据               |
| dataType | 是    | Integer       | 数据类型，1-证件号；3-手机；9-其它 |

当数据类型为 1 和 3 时使用 AES 算法。

#### 回复参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
| return | String | 是    | Base64编码的密文 |

### 数据解密

```java
String decryptData(String data) throws SeeingException;
String decryptData(byte[] data) throws SeeingException;
```

#### 入参说明

| 参数名  | 必填   | 类型            | 说明                                  |
| ---- | ---- | ------------- | ----------------------------------- |
| data | 是    | String或Byte[] | 要解密的内容，Base64编码的String密文或是Byte[]的密文 |

#### 回复参数

| 参数名    | 类型     | 必填   | 说明            |
| ------ | ------ | ---- | ------------- |
| return | String | 是    | 解密后的UTF8编码的明文 |

### 获得关键数据

```java
String getSecretData(Integer type, String flag) throws SeeingException;
String getSecretData(Integer type) throws SeeingException; // 通用数据
```

| 参数名  | 必填   | 类型      | 说明        |
| ---- | ---- | ------- | --------- |
| type | 是    | Integer | 数据类型      |
| flag | 否    | String  | 数据标志，服务相关 |

| 数据类型                     | 说明       |
| ------------------------ | -------- |
| 1-阿里云OSS的AccessKeyId     |          |
| 2-阿里云OSS的AccessKeySecret |          |
| 3-云片的apikey              |          |
| 4-数据库用户名                 | 需要指定falg |
| 5-数据库密码                  | 需要指定falg |
| 6-Redis服务密码              |          |
| 7-RabbitMQ用户名            | 需要指定falg |
| 8-RabbitMQ密码             | 需要指定falg |
| 9-阿里云邮箱推送的AccessKey      |          |
| 10-阿里云邮箱推送的AccessSecret  |          |

| 服务        | 数据标志falg       |
| --------- | -------------- |
| 基础服务      | core           |
| 通知服务      | notify         |
| 文件资源服务    | file           |
| 回调服务      | callback       |
| 支付服务      | gtpay          |
| 公共服务      | public         |
| WEB组服务    | web            |
| 移动-租户     | mobile         |
| 移动-患者     | mobile-patient |
| 移动-医护     | mobile-person  |
| OPENAPI服务 | openapi        |

## KMS私有接口

### 初始化

```java
void initKMS() throws SeeingException;
```

### 添加数据密钥

暂不提供

### 添加关键数据

```java
void setSecretData(Integer type, String flag, String data) throws SeeingException;
void setSecretData(Integer type, String data) throws SeeingException; // 通用数据
```

| 参数名  | 必填   | 类型      | 说明        |
| ---- | ---- | ------- | --------- |
| type | 是    | Integer | 数据类型      |
| flag | 否    | String  | 数据标志，服务相关 |
| data | 是    | String  | 存储的数据内容   |

| 数据类型                     | 说明       |
| ------------------------ | -------- |
| 1-阿里云OSS的AccessKeyId     |          |
| 2-阿里云OSS的AccessKeySecret |          |
| 3-云片的apikey              |          |
| 4-数据库用户名                 | 需要指定falg |
| 5-数据库密码                  | 需要指定falg |
| 6-Redis服务密码              |          |
| 7-RabbitMQ用户名            | 需要指定falg |
| 8-RabbitMQ密码             | 需要指定falg |
| 9-阿里云邮箱推送的AccessKey      |          |
| 10-阿里云邮箱推送的AccessSecret  |          |


#HTTP基础服务协议基本信息
端口号：14004
redis：4

#流水号

### 获取全局流水号

`url`
[GET]/core/serialObtain/getGlobaSerialNumber/{flag}
``

####入参：

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| flag | String | 是    | 标志 |

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | long | 是    | 全局流水号 |

### 获取一天的流水号

`url`
[GET]/core/serialObtain/serialNumberByDay/{flag}
``

####入参：

#### RequestHeader

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| tenantId | Long | 是    | 租户ID |

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| flag | String | 是    | 标志 |

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | long | 是    | 流水号 |


### 获取一天的流水号（带前缀）返回String型

`url`
[GET]/core/serialObtain/serialNumberPrefixByDay/{flag}/{prefix}/{serialSize}
``

####入参：

#### RequestHeader

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| tenantId | Long | 是    | 租户ID |

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| flag | String | 是    | 标志 |
| prefix|String|是     | 流水号前缀     | 
| serialSize |Integer |是| 流水号长度，0补位 | 

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | String | 是    | 流水号 |



### 获取一天的流水号（带前缀）返回long型

`url`
[GET]/core/serialObtain/serialNumberDigitPrefixByDay/{flag}/{prefix}/{serialSize}
``

####入参：

#### RequestHeader

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| tenantId | Long | 是    | 租户ID |

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| flag | String | 是    | 标志 |
| prefix|String|是     | 流水号前缀     | 
| serialSize |Integer |是| 流水号长度，0补位 | 

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | long | 是    | 流水号 |


### 获取租户内永不重复的流水号

`url`
[GET]/core/serialObtain/globalSerialNumber/{flag}
``

####入参：

#### RequestHeader

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| tenantId | Long | 是    | 租户ID |

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| flag | String | 是    | 标志 |

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | long | 是    | 流水号 |


###获取租户内的订单流水号

`url`
[GET]/core/serialObtain/orderSerialNumberByDay/{flag}/{serialSize}
``

####入参：

#### RequestHeader

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| tenantId | Long | 是    | 租户ID |

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| flag | String | 是    | 标志 |
| prefix|String|是     | 流水号前缀     | 
| serialSize |Integer |是| 流水号长度，0补位 | 

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | String | 是    | 订单流水号,高位补0 |


# ID

###获得一个新的ID（ID类型自己参数选择）

`URL`
[GET]/core/id/getNextId/{idType}
``

####入参：

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| idType | Integer | 是    | 需要获取的ID类型（常量类在com.seeing.id.bean.IDType中） |

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | long | 是    | id |



##### 批量获取ID（ID类型自己参数选择）

`URL`
[GET]/core/id/getBatchIds/{idType}/{count}
``

####入参：

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| idType | Integer | 是    | 需要获取的ID类型（常量类在com.seeing.id.bean.IDType中） |
| count | Integer | 是    | 批量获取的数量 |

#### 回复报文参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|      | list<long> | 是    | id列表 |




# KMS 

###数据加密

`url`
[GET]/core/kms/encrypeData/{data}/{dataType}
``

#### 入参说明

#### PathVariable

| 参数名      | 必填   | 类型            | 说明                   |
| -------- | ---- | ------------- | -------------------- |
| data  | 是    | String  | 要加密的数据               |
| dataType | 是    | Integer       | 数据类型，1-证件号；3-手机；9-其它 |

当数据类型为 1 和 3 时使用 AES 算法。

#### 回复参数

| 参数名    | 类型     | 必填   | 说明          |
| ------ | ------ | ---- | ----------- |
|        | String | 是    | Base64编码的密文 |

### 数据解密

`url`
[GET]/core/kms/decryptData/{data}

#### 入参说明

#### PathVariable

| 参数名      | 必填   | 类型            | 说明                   |
| -------- | ---- | ------------- | -------------------- |
| data  | 是    | String  | 要解密的内容，Base64编码的String密文      |


#### 回复参数

| 参数名    | 类型     | 必填   | 说明            |
| ------ | ------ | ---- | ------------- |
|   | String | 是    | 解密后的UTF8编码的明文 |

### 获得关键数据

`url`
[GET]/core/kms/getSecretData/{type}/{flag}
``

#### 入参说明

#### PathVariable
| 参数名  | 必填   | 类型      | 说明        |
| ---- | ---- | ------- | --------- |
| type | 是    | Integer | 数据类型      |
| flag | 否    | String  | 数据标志，服务相关 |

#### 回复参数

| 参数名    | 类型     | 必填   | 说明            |
| ------ | ------ | ---- | ------------- |
|   | String | 是    | 解密后的UTF8编码的明文 |

| 数据类型                     | 说明       |
| ------------------------ | -------- |
| 1-阿里云OSS的AccessKeyId     |          |
| 2-阿里云OSS的AccessKeySecret |          |
| 3-云片的apikey              |          |
| 4-数据库用户名                 | 需要指定falg |
| 5-数据库密码                  | 需要指定falg |
| 6-Redis服务密码              |          |
| 7-RabbitMQ用户名            | 需要指定falg |
| 8-RabbitMQ密码             | 需要指定falg |
| 9-阿里云邮箱推送的AccessKey      |          |
| 10-阿里云邮箱推送的AccessSecret  |          |

| 服务        | 数据标志falg       |
| --------- | -------------- |
| 基础服务      | core           |
| 通知服务      | notify         |
| 文件资源服务    | file           |
| 回调服务      | callback       |
| 支付服务      | gtpay          |
| 公共服务      | public         |
| WEB组服务    | web            |
| 移动-租户     | mobile         |
| 移动-患者     | mobile-patient |
| 移动-医护     | mobile-person  |
| OPENAPI服务 | openapi        |

### 获得关键数据

`url`
[GET]/core/kms/getSecretData/{type}
``

#### 入参说明

#### PathVariable
| 参数名  | 必填   | 类型      | 说明        |
| ---- | ---- | ------- | --------- |
| type | 是    | Integer | 数据类型      |

#### 回复参数

| 参数名    | 类型     | 必填   | 说明            |
| ------ | ------ | ---- | ------------- |
|   | String | 是    | 加密后的内容|

## KMS私有接口

### 添加数据密钥

暂不提供

### 添加关键数据

`url`
[POST]/core/kms/setSecretData

#### 入参说明

#### PathVariable
| 参数名  | 必填   | 类型      | 说明        |
| ---- | ---- | ------- | --------- |
| type | 是    | Integer | 数据类型      |
| flag | 是    | String  | 数据标志，服务相关 |
| data | 是    | String  | 存储的数据内容   |

[POST]/core/kms/setSecretData1

#### PathVariable
| 参数名  | 必填   | 类型      | 说明        |
| ---- | ---- | ------- | --------- |
| type | 是    | Integer | 数据类型      |
| data | 是    | String  | 存储的数据内容   |

| 数据类型                     | 说明       |
| ------------------------ | -------- |
| 1-阿里云OSS的AccessKeyId     |          |
| 2-阿里云OSS的AccessKeySecret |          |
| 3-云片的apikey              |          |
| 4-数据库用户名                 | 需要指定falg |
| 5-数据库密码                  | 需要指定falg |
| 6-Redis服务密码              |          |
| 7-RabbitMQ用户名            | 需要指定falg |
| 8-RabbitMQ密码             | 需要指定falg |
| 9-阿里云邮箱推送的AccessKey      |          |
| 10-阿里云邮箱推送的AccessSecret  |          |

#PasswordEncrypt

###对密码明文进行加密

`url`
[GET]/core/passwordEncrypt/{accountId}/{plaintext}

#### 入参说明

#### RequestHeader

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| tenantId | Long | 是    | 租户ID |

#### PathVariable

| 参数名      | 类型   | 必填   | 说明   |
| -------- | ---- | ---- | ---- |
| plaintext | 是    | String  |密码明文 |
| accountId  | 是    | Long  |账号ID   |  

#### 回复参数

| 参数名    | 类型     | 必填   | 说明            |
| ------ | ------ | ---- | ------------- |
|   | String | 是    | 加密后的内容，Base64结构 |



