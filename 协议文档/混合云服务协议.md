# 混合云服务协议

## 基本信息

端口号：8019
RedisDB：12

## 协议列表

### 本地数据库连接参数协议

```http
[GET]/hybrid/connection/parameters
```

#### 修改更新记录

|   对应版本   | 说明 |
|--------------|------|
| 混合云V1.0.0 | 新增 |

#### 请求报文参数

|  参数名   | 类型 | 必填 |  说明  |
|-----------|------|------|--------|
| tenant_id | Long | 是   | 租户ID |

#### 回复报文参数

|   参数名   |   类型  | 必填 |         说明         |
|------------|---------|------|----------------------|
| version    | Integer | 是   | 当前线上数据库版本ID |
| host       | String  | 是   | 线下数据库地址       |
| port       | String  | 是   | 线下数据库端口       |
| schemaname | String  | 是   | 线下数据库名         |
| username   | String  | 是   | 线下数据库账号       |
| password   | String  | 否   | 线下数据库密码       |

### 数据获取协议

```http
[GET]/hybrid/sync_data
```

说明：
1. 线上与线下数据库版本ID不一致时要求适配器调用表结构协议，进行结构升级。
2. 数据内容从redis中取。
3. 调用本接口时redis要做客户端有连接处理的标志。

#### 修改更新记录

|   对应版本   | 说明 |
|--------------|------|
| 混合云V1.0.0 | 新增 |

#### 请求报文参数

|  参数名   |   类型  | 必填 |              说明              |
|-----------|---------|------|--------------------------------|
| tenant_id | Long    | 是   | 租户ID                         |
| version   | Integer | 是   | 线下数据库版本ID               |
| size      | Integer | 是   | 获得同步数据量，最小1，最大100 |

#### 回复报文参数

|  参数名   |     类型    | 必填 |         说明         |
|-----------|-------------|------|----------------------|
| version   | Integer     | 是   | 当前线上数据库版本ID |
| sync_data | ObjectArray | 否   | 要同步的数据         |

要同步的数

|    参数名    |     类型    | 必填 |                       说明                      |
|--------------|-------------|------|-------------------------------------------------|
| data_id      | String      | 是   | 数据ID                                          |
| data_time    | Long        | 是   | 数据产生时间,数据执行时间                       |
| data_version | Integer     | 是   | 数据版本                                        |
| data_type    | String      | 是   | INSERT-插入数据;UPDATE-更新数据;DELETE-删除数据 |
| table        | String      | 是   | 表名                                            |
| columns      | ObjectArray | 是   | 字段数据内容                                    |

字段数据内容

|   参数名   |   类型  | 必填 |      说明      |
|------------|---------|------|----------------|
| name       | String  | 是   | 字段名         |
| value      | String  | 是   | 值             |
| is_key     | Boolean | 是   | 是否主键       |
| is_updated | Boolean | 是   | 是否被更新的值 |

### 表结构变更语句获取协议

```http
[GET]/hybrid/sync_ddl_data
```

说明：
1. 数据内容从redis中取。

#### 修改更新记录

|   对应版本   | 说明 |
|--------------|------|
| 混合云V1.0.0 | 新增 |

#### 请求报文参数

| 参数名    | 类型    | 必填 | 说明                           |
| --------- | ------- | ---- | ------------------------------ |
| tenant_id | Long    | 是   | 租户ID                         |
| size      | Integer | 是   | 获得同步数据量，最小1，最大100 |

#### 回复报文参数

|  参数名   |     类型    | 必填 |         说明         |
|-----------|-------------|------|----------------------|
| version   | Integer     | 是   | 当前线上数据库版本ID |
| sync_data | ObjectArray | 否   | 要同步的数据         |

要同步的数

|  参数名   |   类型  | 必填 |                                                  说明                                                  |
|-----------|---------|------|--------------------------------------------------------------------------------------------------------|
| data_id   | String  | 是   | 变更数据ID                                                                                             |
| version   | Integer | 是   | 这个DDL语句对应的结构版本                                                                              |
| data_time | Long    | 是   | 变更数据产生时间,数据执行时间                                                                          |
| data_type | String  | 是   | CREATE-创建表;ALTER-修改表结构; CINDEX-创建索引;DINDEX-删除索引;RENAME-修改表名;ERASE-删除表;          |
| table     | String  | 是   | 表名                                                                                                   |
| ddl_sql   | String  | 是   | 是DDL操作时的SQL语句，请注意过滤语句中表名前会加库前缀的问题，如 \`seeing\`.\`test\` 或 seeing.test 等 |

### 表结构协议

```http
[GET]/hybrid/table_struct
```

说明：
1. 版本升级时由服务端把表结构存储在redis中，数据内容从redis中取。
2. 调用本接口时redis要做客户端有连接处理的标志。

获得该租户需要同步的表的结构信息，以帮助线下进行表结构的维护。适配器应以本接口返回的结构做为标准修改线下数据库的表结构。如下情况除外：
1. 线下表结构中字段本为可空的，但线上为非空，这类情况不修改。
2. 线下表结构中字段存在，但云上字段不存在的，线下字段不删除，但修改字段允许为空。
3. 线下数据类型的长度大于云上字段数据类型长度时，这类情况不修改，具体见放宽条件。
4. 线下数据类型为varchar等字符类型，但云上字段为数值时间等类型时，这类情况不修改。
5. 索引在创建时一并创建，但表结构变更修改时索引不再进行维护修改。

数据类型放宽条件及优先级：
LONGTEXT > MEDIUMTEXT > TEXT > TINYTEXT > VARCHAR(N大值优) > CHAR；BLOB系统我们不会使用；
VARCHAR > 时间格式（TIMESTAMP，DATETIME，YEAR，TIME，DATE）；时间格式的转换，只支持转成VARCHAR(N最小20)；
VARCHAR > DECIMAL > DOUBLE > FLOAT；浮点类型(M,D)中M与D值只允许调大，不允许调小。
VARCHAR > BIGINT > INT或INTEGER > MEDIUMINT > SMALLINT > TINYINT；数值类型括号内的值修改无意义，并不支持逆顺转换。

#### 修改更新记录

|   对应版本   | 说明 |
|--------------|------|
| 混合云V1.0.0 | 新增 |

#### 请求报文参数

|  参数名   |  类型  | 必填 |                        说明                       |
|-----------|--------|------|---------------------------------------------------|
| tenant_id | Long   | 是   | 租户ID                                            |
| tables    | String | 否   | 为空时取这个租户下所有同步表的结构,多表以逗号分隔 |

#### 回复报文参数

| 参数名  |    类型    | 必填 |         说明         |
|---------|------------|------|----------------------|
| version | Integer    | 是   | 当前线上数据库版本ID |
| tables  | ObjectList | 是   | 表列表               |

表列表

| 参数名 |    类型    | 必填 |   说明   |
|--------|------------|------|----------|
| table  | String     | 是   | 表名     |
| fields | ObjectList | 是   | 字段列表 |
| ddl    | String     | 是   | 建表语句 |

字段列表

| 参数名  | 类型   | 必填 | 说明                     |
| ------- | ------ | ---- | ------------------------ |
| field   | String | 是   | 字段名                   |
| type    | String | 是   | 数据类型                 |
| is_null | String | 是   | YES是可以空,NO是不可为空 |
| key     | String | 否   | PRI-主键;MUL-索引        |
| default | String | 否   | 默认值                   |
| extra   | String | 否   | 扩展信息                 |

### 数据处理结果确定协议

```http
[POST]/hybrid/ack_commit
```

说明：
1. 版本升级时由服务端把表结构存储在redis中，数据内容从redis中取。
2. 调用本接口时redis要做客户端有连接处理的标志。

#### 修改更新记录

|   对应版本   | 说明 |
|--------------|------|
| 混合云V1.0.0 | 新增 |

#### 请求报文参数

|   参数名    |    类型    | 必填 |                   说明                  |
|-------------|------------|------|-----------------------------------------|
| tenant_id   | Long       | 是   | 租户ID                                  |
| data_type   | Integer    | 是   | 处理的数据类型；1-普通数据；2-DDL数据； |
| ack_success | StringList | 是   | 成功的内容                              |
| ack_error   | ObjectList | 否   | 错误的内容                              |

错误的内容

|  参数名   |  类型  | 必填 |      说明      |
|-----------|--------|------|----------------|
| data_id   | String | 是   | 出错的数据     |
| timestamp | Long   | 是   | 出错时间，毫秒 |
| error     | String | 是   | 出错内容       |

#### 回复报文参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| 无     |      |      |      |

### 状态与错误上报协议

```http
[POST]/hybrid/state_commit
```

说明：
1. 大约3秒报一次正常，但错误要实时报。

#### 修改更新记录

|   对应版本   | 说明 |
|--------------|------|
| 混合云V1.0.0 | 新增 |

#### 请求报文参数

|  参数名   |   类型  | 必填 |                      说明                     |
|-----------|---------|------|-----------------------------------------------|
| tenant_id | Long    | 是   | 租户ID                                        |
| state     | Integer | 是   | 状态;0-正常;1-数据库连接出错;2-表结构更新错误 |
| timestamp | Long    | 否   | 出错时间，毫秒                                |
| error_msg | String  | 否   | 错误的内容                                    |

#### 回复报文参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| 无     |      |      |      |
