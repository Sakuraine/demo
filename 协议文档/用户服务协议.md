# 用户服务协议

## 基本信息

端口号：8012
RedisDB：1
内容范围：用户，账号，账号，认证

## 协议内容

### nginx认证TOKEN协议

```url
[GET]/userauth/nginx/token/auth
```

说明:
1. 本接口是和nginx使用的，特殊的定制化接口。
2. nginx配置的示例：

```conf
## web服务 web-restful

  location ^~ /api/drug_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host   $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8008;
    chunked_transfer_encoding off;
   }

  location ^~ /api/outemr {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host   $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8009;
    chunked_transfer_encoding off;
  }

  location ^~ /api/charge_order_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host   $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8010;
    chunked_transfer_encoding off;
  }

  location ^~ /api/jasreport_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8014;
    chunked_transfer_encoding off;
  }

  location ^~ /api/erp_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8015;
    chunked_transfer_encoding off;
  }

  location ^~ /api/search_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8013;
    chunked_transfer_encoding off;
  }
  
  location ^~ /api/msg_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host   $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8018;
    chunked_transfer_encoding off;
  }

  location ^~ /api/pati_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host   $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8004;
    chunked_transfer_encoding off;
  }

  location ^~ /patient/MP_ {
    proxy_pass http://127.0.0.1:8004;
    chunked_transfer_encoding off;
  }

  location ^~ /api/userauth {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8012;
    chunked_transfer_encoding off;
  }

  location ^~ /api/template_data {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8001;
    chunked_transfer_encoding off;
  }

  location ^~ /api {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8001;
    chunked_transfer_encoding off;
  }

  location /auth {
    internal;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Original-URI $request_uri;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_pass http://127.0.0.1:8012/userauth/nginx/token/auth;
    chunked_transfer_encoding off;
  }

  location @auth401 {
    default_type application/json;
    if ( $auth_error_code = "15" ) {
      # 混合云租户token失效
      return 415 '$auth_error';
    }
    if ( $auth_error_code = "08" ) {
      # URL权限不足
      return 403 '$auth_error';
    }
    if ( $auth_error != "" ) {
      # 普通租户token失效
      return 401 '$auth_error';
    }
    return 401 '{"status":"05","message":"auth failure"}';
  }
```

OPENAPI的nginx的配置不变
1. 本协议无返回报文（但有返回头），通过协议状态来判断是否认证成功，200成功，401或403失败。
2. 本协议会查询redis中索引为1的数据库，数据库的规则为public-service+uuid拼接的字符串
3. 本协议查询的数据库表：pla_tenant，com_role_func，com_user_role，pla_func_protocols，pla_prot_group，pla_work_function
4. 返回的json中的状态05表示token失效或者token错误，06表示租户ID错误，07表示正常租户登入失败，08表示URL权限不足，15表示混合云租户TOKEN验证失败，16表示混合云租户登入失败

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| WEBV1.3.2 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数                | 类型     | 必填   | 说明                  |
| ----------------- | ------ | ---- | ------------------- |
| userId            | String | 否    | 当前请求操作的用户           |
| tenantId          | String | 否    | 当前请求操作的租户           |
| requestId         | String | 是    | 当前请求操作的ID           |
| X-Original-URI    | String | 是    | 原请求地址，包含queryString |
| X-Original-Method | String | 否    | 原请求的方法，如GET,POST    |
| os                | String | 否    | 操作系统                |
| device            | String | 否    | 操作设备                |
| User-Agent        | String | 是    | 浏览器标识               |
| token             | String | 是    | 令牌                  |

#### 回复报文参数

认证成功返回200；
认证失败返回401；

#### Header

| 参数名      | 类型     | 必填   | 说明               |
| -------- | ------ | ---- | ---------------- |
| userId   | String | 否    | 认证成功时返回用户ID      |
| tenantId | String | 否    | 认证成功时返回租户ID      |
| error    | String | 否    | 认证失败时返回信息，不能包含中文 |

error的结构
```java
{
  "status":"05",
  "message":"auth failure"
}
```

### nginx 认证 OPENAPI TOKEN 协议

```url
[GET]/userauth/nginx/openapi_token/auth
```

说明:
1. 本接口是和nginx使用的，特殊的定制化接口。
2. auth/token 结尾的协议要求放行。
3. 返回的json中的状态05表示token失效或者token错误，06表示租户ID错误，07表示正常租户登入失败，08表示URL权限不足，15表示混合云租户TOKEN验证失败，16表示混合云租户登入失败
4. nginx配置的示例：

```conf
  location ~ /v[1-9].[0-9] {
    auth_request /openapi_auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    error_page 401 403 = @openapi_auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    proxy_pass http://127.0.0.1:8002;
    chunked_transfer_encoding off;
  }

  location ^~ /device {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    proxy_pass http://127.0.0.1:8016;
    chunked_transfer_encoding off;
  }

  location ^~ /hybrid {
    auth_request /openapi_auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    error_page 401 403 = @openapi_auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    proxy_pass http://127.0.0.1:8019;
    chunked_transfer_encoding off;
  }

  ## web服务 web-restful,为了支持CEF
  location ^~ /api {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8001;
    chunked_transfer_encoding off;
  }

  # WEB服务，小病历保存for cef 的权限要支持
  location ^~ /api/outemr {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host   $host;
    proxy_set_header X-Real-IP      $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8009;
    chunked_transfer_encoding off;
  }

  # 打印与报表服务，在CEF中病历的预览打印功能
  location ^~ /api/jasreport_service {
    auth_request /auth;
    auth_request_set $userid $sent_http_userId;
    auth_request_set $tenantid $sent_http_tenantId;
    auth_request_set $auth_error $sent_http_error;
    auth_request_set $auth_error_code $sent_http_error_code;
    error_page 401 403 = @auth401;
    proxy_set_header userId $userid;
    proxy_set_header tenantId $tenantid;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    rewrite  ^/api/(.*)$  /$1  break;
    proxy_pass http://127.0.0.1:8014;
    chunked_transfer_encoding off;
  }

  location /openapi_auth {
    internal;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Original-URI $request_uri;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_pass http://127.0.0.1:8012/userauth/nginx/openapi_token/auth;
    chunked_transfer_encoding off;
  }

  location @openapi_auth401 {
    default_type application/json;
    if ( $auth_error != "" ) {
      return 401 '$auth_error';
    }
    return 401 '{"code":"1005","msg":"auth failure"}';
  }

  location /auth {
    internal;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Original-URI $request_uri;
    proxy_next_upstream http_500 http_502 http_504 error timeout;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_pass http://127.0.0.1:8012/userauth/nginx/token/auth;
    chunked_transfer_encoding off;
  }

  location @auth401 {
    default_type application/json;
    if ( $auth_error_code = "15" ) {
      # 混合云租户token失效
      return 415 '$auth_error';
    }
    if ( $auth_error_code = "08" ) {
      # URL权限不足
      return 403 '$auth_error';
    }
    if ( $auth_error != "" ) {
      # 普通租户token失效
      return 401 '$auth_error';
    }
    return 401 '{"status":"05","message":"auth failure"}';
  }

```

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| 混合云V1.0.0 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数                | 类型     | 必填   | 说明                  |
| ----------------- | ------ | ---- | ------------------- |
| userId            | String | 否    | 当前请求操作的用户           |
| tenantId          | String | 否    | 当前请求操作的租户           |
| requestId         | String | 是    | 当前请求操作的ID           |
| X-Original-URI    | String | 是    | 原请求地址，包含queryString |
| X-Original-Method | String | 否    | 原请求的方法，如GET,POST    |
| os                | String | 否    | 操作系统                |
| device            | String | 否    | 操作设备                |
| User-Agent        | String | 是    | 浏览器标识               |
| token             | String | 是    | 令牌                  |

#### 回复报文参数

认证成功返回200；
认证失败返回401；

#### Header

| 参数名      | 类型     | 必填   | 说明                          |
| -------- | ------ | ---- | --------------------------- |
| userId   | String | 否    | 认证成功时返回用户ID                 |
| tenantId | String | 否    | 认证成功时返回租户ID                 |
| error    | String | 否    | 认证失败时返回信息，不能包含中文,且必须是Json结构 |

error的结构
```java
{
  "code":"1005",
  "msg":"auth failure"
}
```

### 用户注册

```http
[POST]/userauth/app/register_login
```

说明：
1. app用户注册并登入

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名    | 类型     | 必填   | 说明                 |
| ------ | ------ | ---- | ------------------ |
| os     | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device | String | 是    | 当前设备名称，如iOS的手机设备名称 |

#### RequestBody
| 参数名      | 类型     | 必填   | 说明      |
| -------- | ------ | ---- | ------- |
| phone    | String | 是    | 用户注册手机号 |
| password | String | 是    | 登入密码    |


#### 回复报文参数

| 参数名       | 类型     | 必填   | 说明     |
| --------- | ------ | ---- | ------ |
| accountId | Long   | 是    | 登入账号ID |
| userId    | Long   | 是    | 用户ID   |
| token     | String | 是    | 登入令牌   |


### 账号密码登入

```http
[POST]/userauth/app/login_by_password
```
说明：
1. 账号密码登入

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestBody

| 参数名      | 类型     | 必填   | 说明    |
| -------- | ------ | ---- | ----- |
| phone    | String | 是    | 登入手机号 |
| password | String | 是    | 登入密码  |

#### 回复报文参数

| 参数名    | 类型         | 必填   | 说明                                       |
| ------ | ---------- | ---- | ---------------------------------------- |
| userId | Long       | 是    | 用户ID                                     |
| name   | String     | 是    | 用户名字                                     |
| avatar | String     | 是    | 头像地址                                     |
| duty   | Integer    | 是    | 职称，职称，null-未知;0-医士;1-医师;2-主治医师;3-副主任医师;4-主任医师 |
| token  | String     | 是    | 登入令牌                                     |
| tenant | ObjectList | 是    | 用户列表                                     |

#### 用户列表

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| userId     | Long   | 是    | 用户ID |
| userName   | String | 是    | 用户名称 |
| avatar     | String | 是    | 用户头像 |
| userDuty   | String | 是    | 用户职责 |
| userJobNum | String | 是    | 用户工号 |
| userPost   | String | 是    | 可存岗位 |
| tenantId   | Long   | 是    | 租户ID |
| tenantName | String | 是    | 租户名称 |
| deptName   | String | 是    | 部门名称 |

### 验证码登入

```http
[POST]/userauth/app/login_by_auth_code
```
说明：
1. app验证码登入

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestBody

| 参数名      | 类型     | 必填   | 说明      |
| -------- | ------ | ---- | ------- |
| phone    | String | 是    | 用户注册手机号 |
| authCode | String | 是    | 登入验证码   |

#### 回复报文参数

| 参数名    | 类型         | 必填   | 说明                                       |
| ------ | ---------- | ---- | ---------------------------------------- |
| userId | Long       | 是    | 用户ID                                     |
| name   | String     | 是    | 用户名字                                     |
| avatar | String     | 是    | 头像地址                                     |
| duty   | Integer    | 是    | 职称，职称，null-未知;0-医士;1-医师;2-主治医师;3-副主任医师;4-主任医师 |
| token  | String     | 是    | 登入令牌                                     |
| tenant | ObjectList | 是    | 用户列表                                     |

#### 用户列表

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| userId     | Long   | 是    | 用户ID |
| userName   | String | 是    | 用户名称 |
| avatar     | String | 是    | 用户头像 |
| userDuty   | String | 是    | 用户职责 |
| userJobNum | String | 是    | 用户工号 |
| userPost   | String | 是    | 可存岗位 |
| tenantId   | Long   | 是    | 租户ID |
| tenantName | String | 是    | 租户名称 |
| deptName   | String | 是    | 部门名称 |

### 多租户登陆后获取令牌

```http
[GET]/userauth/app/applyToken
```

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam

| 参数名    | 类型   | 必填   | 说明   |
| ------ | ---- | ---- | ---- |
| userId | Long | 是    | 用户ID |


#### 回复报文参数

| 参数名       | 类型     | 必填   | 说明     |
| --------- | ------ | ---- | ------ |
| accountId | Long   | 是    | 登入账号ID |
| userId    | Long   | 是    | 用户ID   |
| token     | String | 是    | 登入令牌   |

### WAP用户登入

```http
[POST]/userauth/login
```
说明：
1. wap用户登入
   2.status中最后两位：01表示参数错误，05表示token失效或者token错误，06表示租户ID错误，07表示正常租户登入失败，08表示URL权限不足，15表示混合云租户TOKEN验证失败，16表示混合云租户登入失败

#### 修改更新记录

| 对应版本       | 说明          |
| ---------- | ----------- |
| WEB/V1.3.3 | 修改 增加是否有新消息 |

#### 请求报文参数

| 参数名       | 类型     | 必填   | 说明             |
| --------- | ------ | ---- | -------------- |
| account   | String | 是    | 账号，可以是手机号码、工号等 |
| password  | String | 是    | 密码             |
| auth_id   | String | 否    | 验证码id          |
| auth_code | String | 否    | 验证码            |

header中填写

| 参数名        | 类型     | 必填   | 说明                 |
| ---------- | ------ | ---- | ------------------ |
| tenantId   | Long   | 是    | 租户号                |
| os         | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device     | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| user_agent | String | 是    | 浏览器 类型             |

#### 回复报文参数

| 参数名             | 类型         | 必填   | 说明              |
| --------------- | ---------- | ---- | --------------- |
| fail_times      | Integer    | 是    | 登录失败次数          |
| token           | String     | 是    | 令牌，用于标志用户登录的有效性 |
| user_id         | String     | 是    | 用户唯一id          |
| name            | String     | 是    | 用户姓名            |
| tenant_name     | String     | 是    | 租户名称            |
| view_bidprice   | Integer    | 是    | 是否有查看进价权限 0无1有  |
| new_msg         | Integer    | 是    | 是否有新消息 0无1有     |
| reso_list       | ObjectList | 是    | 资源列表            |
| work_list       | ObjectList | 是    | 工作站列表           |
| depot_list      | ObjectList | 是    | 管理仓库列表          |
| sale_depot_list | ObjectList | 是    | 销售仓库列表          |
| opto_list       | LongList   | 是    | 处方列表            |
| account_list    | ObjectList | 是    | 收费账号列表          |



工作站列表说明

| 参数名       | 类型         | 必填   | 说明     |
| --------- | ---------- | ---- | ------ |
| work_id   | Integer    | 是    | 工作站ID  |
| work_code | String     | 是    | 工作站代码  |
| work_name | String     | 是    | 工作站名称  |
| func_list | ObjectList | 是    | 功能权限列表 |

功能权限列表说明

| 参数名         | 类型      | 必填   | 说明       |
| ----------- | ------- | ---- | -------- |
| func_id     | Long    | 是    | 模块功能ID   |
| func_code   | String  | 是    | 功能代码     |
| func_name   | String  | 是    | 模块功能名称   |
| func_module | Integer | 是    | 模块还是功能标志 |
| func_parent | Long    | 否    | 父级模块ID   |

科室列表说明

| 参数名       | 类型      | 必填   | 说明                         |
| --------- | ------- | ---- | -------------------------- |
| reso_id   | String  | 是    | 资源ID                       |
| reso_type | Integer | 是    | 支撑的资源类型(1-科室；2-设备；3-柜台与仓库) |
| reso_name | String  | 是    | 资源名称                       |

管理仓库或销售仓库列表说明

| 参数名           | 类型      | 必填   | 说明                |
| ------------- | ------- | ---- | ----------------- |
| depo_id       | String  | 是    | 仓库id              |
| depo_name     | String  | 是    | 仓库名称              |
| depo_purchase | Integer | 是    | 是否允许采购入库 ;0:否;1:是 |
| depo_sell     | Integer | 是    | 是否允许销售 ;0:否;1:是   |



收费账号列表说明

| 参数名          | 类型     | 必填   | 说明   |
| ------------ | ------ | ---- | ---- |
| account_id   | String | 是    | 账号id |
| account_name | String | 是    | 账号名称 |







### 发送验证码

```http
[GET]/userauth/app/auth_vcode/{pattern}
```
#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### PathVariable

| 参数名     | 类型     | 必填   | 说明                                       |
| ------- | ------ | ---- | ---------------------------------------- |
| pattern | String | 是    | reg:注册,login:登陆,reset_pwd:重置密码,bind_account:绑定账号 |

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam

| 参数名   | 类型     | 必填   | 说明   |
| ----- | ------ | ---- | ---- |
| phone | String | 是    | 手机号  |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



### 忘记密码验证码检查

```http
[POST]/userauth/app/reset_pwd_auth_code_check
```
#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| phone    | String | 是    | 手机号  |
| authCode | String | 是    | 验证码  |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



### 重置密码时核对验证码

```http
[POST]/userauth/app/check_auth_vcode/reset_pwd
```
说明：
1. app用户注册并登入

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| phone    | String | 是    | 手机号  |
| authCode | String | 是    | 验证码  |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明                |
| ---- | ---- | ---- | ----------------- |
| true | bool |      | true为通过，false为未通过 |



### 验证码重置密码

```http
[POST]/userauth/app/reset_pwd_by_auth_code
```
#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam



##### 入参说明

| 参数名    | 类型     | 必填   | 说明   |
| ------ | ------ | ---- | ---- |
| phone  | String | 是    | 手机号  |
| newPwd | String | 是    | 新密码  |


#### 回复报文参数

| 参数名       | 类型   | 必填   | 说明   |
| --------- | ---- | ---- | ---- |
| accountId | Long | 是    | 账号ID |


###  通过旧密码修改新密码

```http
[POST]/userauth/app/reset_pwd
```

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam

| 参数名    | 类型     | 必填   | 说明   |
| ------ | ------ | ---- | ---- |
| phone  | String | 是    | 手机号  |
| oldPwd | String | 是    | 老密码  |
| newPwd | String | 是    | 新密码  |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



### 绑定账号

```http
[POST]/userauth/app/bind_account
```

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestHeader

| 参数名      | 类型     | 必填   | 说明                 |
| -------- | ------ | ---- | ------------------ |
| os       | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device   | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| tenantId | String | 是    | 用户所在租户（未知时为-1）     |

#### RequestParam

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| phone    | String | 是    | 手机号  |
| authCode | String | 是    | 验证码  |


#### 回复报文参数

| 参数名       | 类型   | 必填   | 说明   |
| --------- | ---- | ---- | ---- |
| appUserId |      |      | 用户ID |


### 检测是否注册

```http
[GET]/userauth/app/check_is_reg
```

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestParam

| 参数名   | 类型     | 必填   | 说明   |
| ----- | ------ | ---- | ---- |
| phone | String | 是    | 手机号  |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |


### 检测验证码

```http
[POST]/userauth/app/check_auth_vcode
```

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.4 | 新增   |

#### 请求报文参数

#### RequestBody

| 参数名      | 类型     | 必填   | 说明     |
| -------- | ------ | ---- | ------ |
| phone    | String | 是    | 注册手机号  |
| authCode | String | 是    | 发送的验证码 |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |

### 用户科室权限

```http
[GET]/userauth/user/depts
```

#### 修改更新记录

| 对应业务      | 说明           |
| --------- | ------------ |
| APPV1.0.4 | 新增（迁移原APP服务） |

#### 请求报文参数

#### RequestBody

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



#### 回复报文参数ObjectList

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| deptId   | String | 是    | 科室ID |
| deptName | String | 是    | 科室名称 |


### 下载文件

```http
[GET]/wechat_service/config/{tena_id}/{file_name}
```

#### 修改更新记录

| 对应业务         | 说明   |
| ------------ | ---- |
| WEB V1.3.3.2 | 新增   |

#### PathVariable
| 参数名       | 类型     | 必填   | 说明         |
| --------- | ------ | ---- | ---------- |
| tena_id   | string | 是    | 租户号        |
| file_name | string | 是    | 文件名称（包括后缀） |

#### 请求报文参数

#### RequestBody

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



#### 回复报文参数ObjectList

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 文件内容 |      |      |      |



### WEB用户登入(密码加密)

```http
[POST]/userauth/web/login
```
说明：
1. WEB用户登入,密码需要加密
   2.status中最后两位：01表示参数错误，05表示token失效或者token错误，06表示租户ID错误，07表示正常租户登入失败，08表示URL权限不足，15表示混合云租户TOKEN验证失败，16表示混合云租户登入失败

#### 修改更新记录

| 对应版本       | 说明          |
| ---------- | ----------- |
| WEB/V1.3.3 | 修改 增加是否有新消息 |

#### 请求报文参数

| 参数名       | 类型     | 必填   | 说明                         |
| --------- | ------ | ---- | -------------------------- |
| account   | String | 是    | 账号，可以是手机号码、工号等             |
| password  | String | 是    | 密码（密码需要加密，base64 encode加密） |
| auth_id   | String | 否    | 验证码id                      |
| auth_code | String | 否    | 验证码                        |

header中填写

| 参数名        | 类型     | 必填   | 说明                 |
| ---------- | ------ | ---- | ------------------ |
| tenantId   | Long   | 是    | 租户号                |
| os         | String | 是    | 客户端操作系统，包含操作系统与版本号 |
| device     | String | 是    | 当前设备名称，如iOS的手机设备名称 |
| user_agent | String | 是    | 浏览器 类型             |

#### 回复报文参数

| 参数名             | 类型         | 必填   | 说明              |
| --------------- | ---------- | ---- | --------------- |
| fail_times      | Integer    | 是    | 登录失败次数          |
| token           | String     | 是    | 令牌，用于标志用户登录的有效性 |
| user_id         | String     | 是    | 用户唯一id          |
| name            | String     | 是    | 用户姓名            |
| tenant_name     | String     | 是    | 租户名称            |
| view_bidprice   | Integer    | 是    | 是否有查看进价权限 0无1有  |
| new_msg         | Integer    | 是    | 是否有新消息 0无1有     |
| reso_list       | ObjectList | 是    | 资源列表            |
| work_list       | ObjectList | 是    | 工作站列表           |
| depot_list      | ObjectList | 是    | 管理仓库列表          |
| sale_depot_list | ObjectList | 是    | 销售仓库列表          |
| opto_list       | LongList   | 是    | 处方列表            |
| account_list    | ObjectList | 是    | 收费账号列表          |



工作站列表说明

| 参数名       | 类型         | 必填   | 说明     |
| --------- | ---------- | ---- | ------ |
| work_id   | Integer    | 是    | 工作站ID  |
| work_code | String     | 是    | 工作站代码  |
| work_name | String     | 是    | 工作站名称  |
| func_list | ObjectList | 是    | 功能权限列表 |

功能权限列表说明

| 参数名         | 类型      | 必填   | 说明       |
| ----------- | ------- | ---- | -------- |
| func_id     | Long    | 是    | 模块功能ID   |
| func_code   | String  | 是    | 功能代码     |
| func_name   | String  | 是    | 模块功能名称   |
| func_module | Integer | 是    | 模块还是功能标志 |
| func_parent | Long    | 否    | 父级模块ID   |

科室列表说明

| 参数名       | 类型      | 必填   | 说明                         |
| --------- | ------- | ---- | -------------------------- |
| reso_id   | String  | 是    | 资源ID                       |
| reso_type | Integer | 是    | 支撑的资源类型(1-科室；2-设备；3-柜台与仓库) |
| reso_name | String  | 是    | 资源名称                       |

管理仓库或销售仓库列表说明

| 参数名           | 类型      | 必填   | 说明                |
| ------------- | ------- | ---- | ----------------- |
| depo_id       | String  | 是    | 仓库id              |
| depo_name     | String  | 是    | 仓库名称              |
| depo_purchase | Integer | 是    | 是否允许采购入库 ;0:否;1:是 |
| depo_sell     | Integer | 是    | 是否允许销售 ;0:否;1:是   |

收费账号列表说明

| 参数名          | 类型     | 必填   | 说明   |
| ------------ | ------ | ---- | ---- |
| account_id   | String | 是    | 账号id |
| account_name | String | 是    | 账号名称 |