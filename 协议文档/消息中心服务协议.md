# 消息中心服务协议

## 基本信息

端口号：8018
RedisDB：0

## 站内消息

### 发送消息

   > [POST]/msg_service/msg/send

支持批量发送

#### 修改更新记录

| 对应版本   | 说明   |
| ------ | ---- |
| V1.3.3 | 新增   |

#### 请求报文参数

| 参数名       | 类型         | 必填   | 说明   |
| --------- | ---------- | ---- | ---- |
| tenantId  | Long       | 是    | 租户ID |
| msg_text  | String     | 是    | 消息内容 |
| user_list | ObjectList | 是    | 用户列表 |

用户列表说明

| 参数名     | 类型   | 必填   | 说明   |
| ------- | ---- | ---- | ---- |
| user_id | Long | 是    | 用户ID |

#### 回复报文参数 ObjectList

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



### 获取消息列表

   > [GET]/msg_service/msg/list

#### 修改更新记录

| 对应版本   | 说明   |
| ------ | ---- |
| V1.3.3 | 新增   |

#### 请求报文参数


| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |

#### 回复报文参数 ObjectList

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| msg_id   | String | 是    | 消息ID |
| msg_text | String | 是    | 消息内容 |


### 消息改为已读

   > [POST]/msg_service/msg/set_read

#### 修改更新记录

| 对应版本   | 说明   |
| ------ | ---- |
| V1.3.3 | 新增   |

#### 请求报文参数


| 参数名    | 类型     | 必填   | 说明   |
| ------ | ------ | ---- | ---- |
| msg_id | String | 是    | 消息ID |

#### 回复报文参数 ObjectList

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |


### 消息全部改为已读

   > [POST]/msg_service/msg/all_set_read

#### 修改更新记录

| 对应版本   | 说明   |
| ------ | ---- |
| V1.3.3 | 新增   |

#### 请求报文参数


| 参数名    | 类型     | 必填   | 说明   |
| ------ | ------ | ---- | ---- |
| userId | String | 是    | 用户ID |

#### 回复报文参数 ObjectList

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |


## 患者端聊天

注意： 关于聊天的实现，主要以redis为主，读消息，读redis。写消息redis和数据库同步写

### 患者选择医生创建会话

```http
[POST]/msg_service/msg/patient/insert_session
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名       | 类型     | 必填   | 说明        |
| --------- | ------ | ---- | --------- |
| member_id | String | 是    | 发送方：就诊人id |
| doctor_id | String | 是    | 接收方：医生id  |

#### 回复报文参数 ObjectList

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| session_no | String | 是    | 会话号  |

### 患者获取历史会话列表

```http
[GET]/msg_service/msg/patient/session_list
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名         | 类型     | 必填   | 说明        |
| ----------- | ------ | ---- | --------- |
| doctor_name | String | 否    | 医生姓名 查询条记 |

#### 回复报文参数 ObjectList

| 参数名               | 类型      | 必填   | 说明                  |
| ----------------- | ------- | ---- | ------------------- |
| session_id        | String  | 是    | 会话ID                |
| session_no        | String  | 是    | 会话号                 |
| doctor_id         | String  | 是    | 医生id                |
| doctor_name       | String  | 是    | 医生姓名                |
| member_name       | String  | 是    | 就诊人姓名               |
| duty_code         | String  | 是    | 会话医生职务              |
| last_message      | String  | 是    | 最后一次对话消息            |
| last_message_type | Integer | 是    | 消息类型  0-文本消息;1-图片消息 |
| last_message_date | String  | 是    | 最后一次对话时间            |
| last_msg_id       | String  | 是    | 最后一次对话ID            |
| member_id         | String  | 是    | 就诊人ID               |
### 患者获取最新会话

```http
[GET]/msg_service/msg/patient/new_session
```
#### 请求报文参数

| 参数名         | 类型     | 必填   | 说明        |
| ----------- | ------ | ---- | --------- |

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 回复报文参数

| 参数名               | 类型      | 必填   | 说明                  |
| ----------------- | ------- | ---- | ------------------- |
| session_id        | String  | 是    | 会话ID                |
| session_no        | String  | 是    | 会话号                 |
| doctor_id         | String  | 是    | 医生id                |
| doctor_name       | String  | 是    | 医生姓名                |
| member_name       | String  | 是    | 就诊人姓名               |
| duty_code         | String  | 是    | 会话医生职务              |
| last_message      | String  | 是    | 最后一次对话消息            |
| last_message_type | Integer | 是    | 消息类型  0-文本消息;1-图片消息 |
| last_message_date | String  | 是    | 最后一次对话时间            |
| last_message_id   | String  | 是    | 最后一次对话ID            |
| member_id         | String  | 是    | 就诊人ID               |


### 患者获取历史消息列表

```http
[GET]/msg_service/msg/patient/msg_list
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型      | 必填   | 说明            |
| ---------- | ------- | ---- | ------------- |
| session_no | String  | 是    | 会话号           |
| page_size  | Integer | 是    | 每页条数          |
| msg_id     | String  | 否    | 历史消息的最后一条消息ID |
| member_id  | String  | 是    | 就诊人ID         |

#### 回复报文参数 ObjectList

消息列表说明

| 参数名              | 类型      | 必填   | 说明                   |
| ---------------- | ------- | ---- | -------------------- |
| msg_id           | String  | 是    | 消息ID                 |
| doctor_id        | String  | 是    | 医生id                 |
| doctor_name      | String  | 是    | 医生姓名                 |
| doctor_photo_url | String  | 是    | 医生头像路径               |
| msg_type         | Integer | 是    | 消息类型  0-文本消息;1-图片消息  |
| from_to          | Integer | 是    | 消息方向  0 我发出的  1 发给我的 |
| message          | String  | 是    | 消息内容                 |
| res_url          | String  | 是    | 图片路径                 |
| msg_date         | String  | 是    | 消息时间                 |


### 患者获取当前会话最新消息

```http
[GET]/msg_service/msg/patient/new_msg
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明    |
| ---------- | ------ | ---- | ----- |
| session_no | String | 是    | 会话号   |
| member_id  | String | 是    | 就诊人ID |
#### 回复报文参数 

| 参数名              | 类型      | 必填   | 说明                   |
| ---------------- | ------- | ---- | -------------------- |
| msg_id           | String  | 是    | 消息ID                 |
| doctor_id        | String  | 是    | 医生id                 |
| doctor_name      | String  | 是    | 医生姓名                 |
| doctor_photo_url | String  | 是    | 医生头像路径               |
| msg_type         | Integer | 是    | 消息类型  0-文本消息;1-图片消息  |
| from_to          | Integer | 是    | 消息方向  0 我发出的  1 发给我的 |
| message          | String  | 是    | 消息内容                 |
| res_url          | String  | 是    | 图片路径                 |
| msg_date         | String  | 是    | 消息时间                 |



### 患者选择医生发送文字消息

```http
[POST]/msg_service/msg/patient/send_text_msg
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明        |
| ---------- | ------ | ---- | --------- |
| member_id  | String | 是    | 发送方：就诊人id |
| doctor_id  | String | 是    | 接收方：医生id  |
| message    | String | 是    | 消息内容      |
| session_no | String | 否    | 会话号       |

#### 回复报文参数 ObjectList

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| msg_id     | String | 是    | 消息ID |
| msg_date   | String | 是    | 消息时间 |
| session_no | String | 是    | 会话号  |
没有会话，需要建立会话

### 患者选择医生发送资源消息

```http
[POST]/msg_service/msg/patient/send_res_msg
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明        |
| ---------- | ------ | ---- | --------- |
| member_id  | Long   | 是    | 发送方：就诊人id |
| doctor_id  | Long   | 是    | 接收方：医生id  |
| file_id    | String | 是    | 文件id      |
| session_no | String | 否    | 会话号       |

#### 回复报文参数 

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| msg_id   | String | 是    | 消息ID |
| file_url | String | 是    | 图片地址 |
| msg_date |        |      |      |

### 患者删除会话

```http
[POST]/msg_service/msg/patient/session_del
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| session_id | String | 是    | 会话号  |

#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



## 医生端聊天


### 医生获取历史会话列表

```http
GET]/msg_service/msg/doctor/session_list
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名       | 类型      | 必填   | 说明                     |
| --------- | ------- | ---- | ---------------------- |
| page_size | Integer | 是    | 每页条数                   |
| msg_id    | String  | 否    | 当前会话最小消息ID，第一次调用的时候可不传 |

#### 回复报文参数 ObjectList

会话列表说明

| 参数名              | 类型      | 必填   | 说明             |
| ---------------- | ------- | ---- | -------------- |
| session_id       | String  | 是    | 会话ID           |
| session_no       | String  | 是    | 会话号            |
| member_id        | String  | 是    | 就诊人ID          |
| member_name      | String  | 是    | 就诊人姓名          |
| member_photo_url | String  | 是    | 就诊人头像路径        |
| gender           | Integer | 是    | 性别，参考《全局约定.md》 |
| age              | String  | 是    | 年龄             |
| phone            | String  | 是    | 手机号            |
| last_message     | String  | 是    | 最后一条消息         |
| last_msg_date    | String  | 是    | 最后一条消息产生时间     |
| last_msg_id      | String  | 是    | 最后一条消息ID       |

### 医生获取最新会话

```http
[GET]/msg_service/msg/doctor/new_session
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 回复报文参数

| 参数名               | 类型      | 必填   | 说明             |
| ----------------- | ------- | ---- | -------------- |
| session_id        | String  | 是    | 会话ID           |
| session_no        | String  | 是    | 会话号            |
| member_id         | String  | 是    | 就诊人ID          |
| member_name       | String  | 是    | 就诊人姓名          |
| member_photo_url  | String  | 是    | 就诊人头像路径        |
| gender            | Integer | 是    | 性别，参考《全局约定.md》 |
| age               | String  | 是    | 年龄             |
| phone             | String  | 是    | 手机号            |
| last_message      | String  | 是    | 最后一条消息,图片时为空   |
| last_message_type |         |      |                |
| last_msg_date     | String  | 是    | 最后一条消息产生时间     |
| last_msg_id       | String  | 是    | 最后一条消息ID       |

### 医生获取历史会话消息列表

```http
[GET]/msg_service/msg/doctor/msg_list
```

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型      | 必填   | 说明   |
| ---------- | ------- | ---- | ---- |
| session_no | String  | 是    | 会话号  |
| page_size  | Integer | 是    | 每页条数 |
| msg_id     | String  | 是    | 消息ID |

#### 回复报文参数

消息列表说明

| 参数名      | 类型      | 必填   | 说明                   |
| -------- | ------- | ---- | -------------------- |
| msg_id   | String  | 是    | 消息ID                 |
| msg_type | Integer | 是    | 消息类型  0-文本消息;1-图片消息  |
| from_to  | Integer | 是    | 消息方向  0 我发出的  1 发给我的 |
| message  | String  | 是    | 消息内容                 |
| res_url  | String  | 是    | 图片路径                 |
| msg_date | String  | 是    | 消息时间                 |

### 医生获取会话最新消息

   > [GET]/msg_service/msg/doctor/new_msg

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| session_no | String | 是    | 会话号  |
|            |        |      |      |

#### 回复报文参数 

| 参数名      | 类型      | 必填   | 说明                   |
| -------- | ------- | ---- | -------------------- |
| msg_id   | String  | 是    | 消息ID                 |
| msg_type | Integer | 是    | 消息类型  0-文本消息;1-图片消息  |
| from_to  | Integer | 是    | 消息方向  0 我发出的  1 发给我的 |
| message  | String  | 是    | 消息内容                 |
| res_url  | String  | 是    | 图片路径                 |
| msg_date | String  | 是    | 消息时间                 |

### 医生发送文字消息

   > [POST]/msg_service/msg/doctor/send_text_msg

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| message    | String | 是    | 消息内容 |
| session_no | String | 是    | 会话号  |

#### 回复报文参数 

| 参数名      | 类型     | 必填   | 说明   |
| -------- | ------ | ---- | ---- |
| msg_id   | String | 是    | 消息ID |
| msg_date | String | 是    | 消息时间 |


### 医生发送资源消息

   > [POST]/msg_service/msg/doctor/send_res_msg

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| file_id    | String | 是    | 文件id |
| session_no | String | 是    | 会话号  |

#### 回复报文参数

| 参数名      | 类型     | 必填   | 说明    |
| -------- | ------ | ---- | ----- |
| msg_id   | String | 是    | 消息ID  |
| res_url  | String | 是    | 文件url |
| msg_date | String | 是    |       |

### 医生删除会话

   > [POST]/msg_service/msg/doctor/session_del

#### 修改更新记录

| 对应版本         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |

#### 请求报文参数

| 参数名        | 类型     | 必填   | 说明   |
| ---------- | ------ | ---- | ---- |
| session_id | String | 是    | 会话ID |

#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |



### 聊天文件预上传

```http
[POST]/msg_service/msg/file/pre_upload
```

说明：
  获取oss地址，文件名等信息

#### 修改更新记录

| 对应业务         | 说明   |
| ------------ | ---- |
| PAT_V1.0.2.1 | 新增   |


#### 请求报文参数

| 参数名            | 类型     | 必填   | 说明                |
| -------------- | ------ | ---- | ----------------- |
| file_size      | Long   | 否    | 文件内容长度            |
| file_extension | String | 是    | 文件扩展名(不带“.“)      |
| file_type      | String | 是    | 文件类型，Content-Type |
| msg_session    | String | 是    | 消息会话号             |



#### 回复报文参数

| 参数名            | 类型     | 必填   | 说明                       |
| -------------- | ------ | ---- | ------------------------ |
| url            | String | 是    | 文件上传的oss的URL             |
| fileId         | Long   | 是    | 文件资源id                   |
| OSSAccessKeyId | String | 是    | Bucket 拥有者的Access Key Id |
| policy         | String | 是    | Base64编码的JSON内容          |
| signature      | String | 是    | 签名                       |
| key            | String | 是    | 上传文件路径                   |