# 设备服务协议

## 基本信息

端口号：8016
RedisDB：14

## AppWeb相关协议

### AppWeb注册协议

```url
[POST]/device/manage/appweb/register
```

说明：
1. 由WEB页面把APPWEB注册到服务端上。

#### 修改更新记录

| 对应业务       | 说明 |
|------------|----|
| 后台服务V1.0.3 | 新增 |

#### 影响的表

AppWeb信息状态表(appweb_state_info)

#### 请求报文参数

| 参数名             | 长度 | 类型      | 必填 | 说明              |
|-----------------|----|---------|----|-----------------|
| appweb_code     | 64 | String  | 是  | 程序标识，从APPWEB中获取 |
| appweb_version  |    | String  | 否  | 程序版本，从APPWEB中获取 |
| appweb_host     |    | String  | 是  | 所在主机地址          |
| appweb_port     |    | Integer | 是  | 服务端口            |
| appweb_ssl_port |    | Integer | 否  | 服务HTTPS端口       |
| appweb_reguser  |    | String  | 是  | 注册用户ID，谁调用的注册协议 |
| appweb_tena_id  |    | String  | 是  | 租户ID            |

#### 回复报文参数

| 参数名 | 类型 | 必填 | 说明 |
|-----|----|----|----|
|     |    |    |    |


### AppWeb最新版本

```url
[GET]/device/appweb/last/version
```

说明：
1. 由WEB页面反APPWEB注册到服务端上。

#### 修改更新记录

|    对应业务    | 说明 |
|----------------|------|
| 后台服务V1.0.3 | 新增 |

#### 请求报文参数

| 参数名 | 长度 | 类型 | 必填 | 说明 |
|--------|------|------|------|------|
|        |      |      |      |      |

#### 回复报文参数

| 参数名  |  类型  | 必填 |   说明   |
|---------|--------|------|----------|
| version | String | 是   | 版本     |
| time    | String | 是   | 发布时间 |
| url     | String | 是   | 下载地址 |

### AppWeb状态上报协议

```url
[POST]/device/appweb/status
```

说明：
1. 上报appweb的状态，说自己还活着。
2. 如果appweb未注册，那么打回。
3. 租户ID可以不传，但如果传了就必须与注册时使用的租户号一致。

#### 修改更新记录

|    对应业务    | 说明 |
|----------------|------|
| 后台服务V1.0.3 | 新增 |

#### 影响的表

AppWeb信息状态表(appweb_state_info)

#### 请求报文参数

|     参数名      | 长度 |   类型  | 必填 |           说明           |
|-----------------|------|---------|------|--------------------------|
| appweb_code     |   64 | String  | 是   | 程序标识，从APPWEB中获取 |
| appweb_version  |      | String  | 否   | 程序版本，从APPWEB中获取 |
| appweb_host     |      | String  | 否   | 所在主机地址             |
| appweb_port     |      | Integer | 否   | 服务端口                 |
| appweb_ssl_port |      | Integer | 否   | 服务HTTPS端口            |
| appweb_tena_id  |      | String  | 否   | 租户ID                   |

#### 回复报文参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
|        |      |      |      |

### AppWeb操作记录协议

```url
[POST]/device/appweb/operating_record
```

说明：
1. 上报appweb的操作记录，现阶段并不落地。

#### 修改更新记录

|    对应业务    | 说明 |
|----------------|------|
| 后台服务V1.0.3 | 新增 |

#### 影响的表

暂不落地

#### 请求报文参数

|     参数名      |  类型  | 必填 |        说明        |
|-----------------|--------|------|--------------------|
| appweb_code     | String | 是   | 程序标识           |
| appweb_url      | String | 是   | 操作的地址         |
| appweb_user     | String | 是   | 操作的人           |
| appweb_request  | String | 否   | 操作请求报文       |
| appweb_response | String | 是   | 操作回复报文       |
| appweb_time     | String | 否   | 操作时间，单位毫秒 |
| appweb_tena_id  | String | 否   | 租户ID             |

#### 回复报文参数

|   参数名    | 长度 |  类型  | 必填 |   说明   |
|-------------|------|--------|------|----------|
| appweb_code |   64 | String | 否   | 程序标识 |


### 角膜地形图文件预上传

```http
[POST]/device/appweb/file_cornea/pre_upload
```

说明：
  获取oss地址，文件名等信息
  设备未注册，不允许调用协议

#### 修改更新记录

|   对应业务  | 说明 |
|-------------|------|
| Web 1.3.3.1 | 新增 |


#### 请求报文参数

|     参数名     |   类型  | 必填 |              说明              |
|----------------|---------|------|--------------------------------|
| appweb_code    | String  | 是   | 程序标识                       |
| file_size      | Long    | 否   | 文件内容长度                   |
| file_extension | String  | 是   | 文件扩展名(不带“.“)            |
| file_type      | String  | 是   | 文件类型，Content-Type         |
| source_type    | Integer | 是   | 14 角膜地形图导出的MXF文件     |
| tenant_id      | String  | 否   | 租户id 为空 由 appweb_code决定 |


#### 回复报文参数

|      参数名       |  类型  | 必填 |             说明             |
|-------------------|--------|------|------------------------------|
| url               | String | 是   | 文件上传的oss的URL           |
| file_id           | Long   | 是   | 文件资源id                   |
| OSS_access_key_id | String | 是   | Bucket 拥有者的Access Key Id |
| policy            | String | 是   | Base64编码的JSON内容         |
| signature         | String | 是   | 签名                         |
| key               | String | 是   | 上传文件路径                 |


### 角膜地形图文件 确认已上传

```http
[POST]/device/appweb/file_cornea/pre_upload
```

说明：
  确认file_id对应的文件

#### 修改更新记录

|   对应业务  | 说明 |
|-------------|------|
| Web 1.3.3.1 | 新增 |


#### 请求报文参数

|   参数名    |  类型  | 必填 |              说明              |
|-------------|--------|------|--------------------------------|
| appweb_code | String | 是   | 程序标识                       |
| file_id     | Long   | 是   | 文件资源id                     |
| tenant_id   | String | 否   | 租户id 为空 由 appweb_code决定 |


#### 回复报文参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| 无     |      |      |      |

#### 上传完成之后发消息

队列名称: SC_CORNEA_ANALYSIS

RedisDB: 15

涉及表：check_cornea_topog_file

消息队列的内容是:

| 参数名  |  类型  | 必填 |     说明     |
|---------|--------|------|--------------|
| file_id | String | 是   | 地形图文件ID |

## 自助机相关协议

### 自助机注册协议

```url
[POST]/device/manage/atm/register
```

说明：
1. 由WEB页面把自助机注册到服务端上。

#### 请求报文参数

| 参数名       | 类型     | 长度 | 必填 | 说明      |
|-----------|--------|----|----|---------|
| atm_code  | String | 64 | 是  | 自助机标识   |
| atm_name  | String | 64 | 是  | 自助机名称   |
| atm_place | String | 64 | 否  | 自助机所处位置 |

#### 回复报文参数

| 参数名    | 类型     | 必填 | 说明      |
|--------|--------|----|---------|
| atm_id | String | 是  | 自助机后台ID |

### 自助机禁用协议

```url
[POST]/device/manage/atm/enable
```

#### 请求报文参数

| 参数名        | 类型      | 必填 | 说明        |
|------------|---------|----|-----------|
| atm_id     | String  | 是  | 自助机后台ID   |
| atm_enable | Integer | 是  | 1-可用，0-禁用 |

#### 回复报文参数

| 参数名    | 类型     | 必填 | 说明      |
|--------|--------|----|---------|
| atm_id | String | 是  | 自助机后台ID |

### 自助机物品入库协议

```url
[POST]/device/manage/atm/putin
```

#### 请求报文参数

| 参数名        | 类型         | 长度 | 必填 | 说明      |
|------------|------------|----|----|---------|
| atm_id     | String     | 64 | 是  | 自助机后台ID |
| ship_goods | ObjectList |    | 是  | 入库商品列表  |

##### 外转设备状态列表

| 参数名         | 类型      | 长度 | 必填 | 说明   |
|-------------|---------|----|----|------|
| goods_id    | String  |    | 是  | 商品ID |
| goods_place | String  | 8  | 是  | 入库位置 |
| goods_num   | Integer |    | 是  | 入库数量 |


## 检查设备协议  

### 检查设备信息新增和修改

> [post]/device/manage/model_device/base

#### 检查设备信息新增和修改

| 对应版本   | 说明          |
|--------|-------------|
| V1.3.7 | 检查设备信息新增和修改 |

#### 请求参数报文
| 参数名                       | 类型      | 必填 | 说明                                                  |
|---------------------------|---------|----|-----------------------------------------------------|
| model_id                  | Long    | 否  | 新增操作时候不填   修改时候为必填                                  |
| model_device_name         | String  | 是  | 设备名称必须唯一                                            |
| model_device_factory      | String  | 否  | 设备厂家                                                |
| model_device_model        | String  | 是  | 设备型号                                                |
| model_device_report_type  | Integer | 是  | 设备报告类型  1: 角膜地形图  2：角膜内皮镜 3：眼轴                      |
| model_device_connect_type | Integer | 是  | 对接方式  1: 报告手动采集 2：报告自动采集 3：数据对接                     |
| model_device_data_type    | Integer | 是  | 设备数据类型  1: .mxf  2：.xls/.xlsx  3：图片格式(png/jpg/jpeg) |

#### 回复参数报文

| 参数名      | 类型   | 必填 | 说明       |
|----------|------|----|----------|
| model_id | Long | 是  | 设备型号表中id |


### 获得检查设备列表

> [get]/device/manage/model_device/list

#### 获得检查设备列表新增和修改

| 对应版本   | 说明       |
|--------|----------|
| V1.3.7 | 获得检查设备列表 |


#### 请求参数报文

| 参数名       | 类型      | 必填 | 说明           |
|-----------|---------|----|--------------|
| page_size | Integer | 是  |  每页数量(默认为 10)  |
| page_num  | Integer | 是  | 页码(默认为 1)  |

#### 回复参数报文 
| 参数名          | 类型         | 必填 | 说明   |
|--------------|------------|----|------|
| page_num     | Integer    | 是  | 页码   |
| page_size    | Integer    | 是  | 每页数量 |
| pages        | Integer    | 是  | 总页数  |
| total        | Integer    | 是  | 总数量  |
| modelDevices | ObjectList | 是  | 设备列表 |

| 参数名                | 类型     | 必填 | 说明     |
|--------------------|--------|----|--------|
| model_id           | Long   | 是  | 设备类型id |
| model_device_name  | String | 是  | 设备名称   |
| model_device_model | String | 是  | 设备型号   |

## ajax监控协议

### 新增ajax请求记录协议

> [post]/device/ajax/record/insert

#### 新增ajax请求记录协议

| 对应版本    | 说明                 |
| ----------- | -------------------- |
| BOSS-V1.0.3 | 新增ajax请求记录协议 |

#### 请求参数报文：

##### requestHeader:

| 参数名   | 类型 | 必填 | 说明   |
| -------- | ---- | ---- | ------ |
| tenantId | Long | 是   | 租户号 |
| userId   | Long | 是   | 用户ID |

##### requestBody:

| 参数名         | 类型    | 必填 | 说明                                       |
| -------------- | ------- | ---- | ------------------------------------------ |
| request_id     | Long    | 是   | 全局唯一的requestId                        |
| request_url    | String  | 是   | 请求地址                                   |
| request_method | Integer | 是   | 请求方式：0-get；1-post；2-put；3:-delete  |
| request_header | String  | 否   | 请求头                                     |
| request_body   | String  | 否   | 请求体                                     |
| status_code    | Integer | 是   | 响应状态码（如：200、404等）。响应超时为-1 |
| request_time   | Long    | 是   | 请求时间，单位：毫秒                       |
| response_time  | Long    | 是   | 响应时间，单位：毫秒                       |
| error_message  | String  | 否   | 异常信息                                   |
| page_url       | String  | 否   | 页面地址                                   |
| source         | Integer | 是   | 请求来源：0-web；1-app；2：微信            |
| source_ip      | String  | 否   | 请求端IP地址                               |

#### 回复参数报文：

无

### 获得设备报告类型列表

> [get]/device/manage/report_type/list

#### 获得设备报告类型列表新增和修改

| 对应版本       | 说明         |
|------------|------------|
| V1.3.9.3.2 | 获得设备报告类型列表 |


#### 请求参数报文

| 参数名 | 类型 | 必填 | 说明 |
|-----|----|----|----|
|     |    |    |    |

#### 回复参数报文 
| 参数名   | 类型         | 必填 | 说明   |
|-------|------------|----|------|
| types | ObjectList | 是  | 类型列表 |

| 参数名         | 类型      | 必填 | 说明                |
|-------------|---------|----|-------------------|
| type_id     | Long    | 是  | 全局唯一的id    |
| type_name   | String  | 是  | 类型名称必须唯一          |
| type_code   | String  | 是  | 类型code            |
| type_remark | String  | 是  | 类型备注              |
| type_enable | Integer | 是  | 是否启用 0: 停用  1： 启用 |