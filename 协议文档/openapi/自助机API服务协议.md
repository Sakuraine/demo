# 自助机API服务协议

版本：V0.1(20190920)


## 说明:


本文档用于描述提供给自助机使用的接口协议，本文档协议为OpenApi协议族的子集，所有通讯规范请遵守《OpenApi接口说明》。


## 一、接入准备及相关说明

1、用户接入医疗平台，首先需要准备一组密钥对，并且将公钥上传到医疗平台。密钥对生成方法用户可自行选择，例如利用ssh、openssl等软件或者互联网上在线生成工具，甚至自行代码生成均可。

2、用户将生成的公钥通过管理系统上传到医疗平台，获取由平台返回给用户的一个公钥所对应的key。

### 调用API必须遵循以下规则：

|   约定   |                                            说明                                           |
|----------|-------------------------------------------------------------------------------------------|
| 传输方式 | 为保证安全性，采用HTTPS传输                                                               |
| 提交方式 | 查询类采用POST方式提交，资源操作类使用POST、GET、PUT、DELETE对应CRUD                      |
| 数据格式 | 提交和返回数据都为JSON格式                                                                |
| 字符编码 | 统一采用UTF-8字符编码                                                                     |
| 签名算法 | 算法默认使用RSA，由接入端生成密钥的时候指定。但允许用户通过参数传递。接入端向平台提供公钥 |
| 签名要求 | 认证接口使用签名                                                                          |
| 判断逻辑 | 先判返回码，再处理返回内容                                                                |

* 时间
标准北京时间，时区为东八区；如果商户的系统时间为非标准北京时间。参数值必须根据商户系统所在时区先换算成标准北京时间， 例如商户所在地为0时区的伦敦，当地时间为2014年11月11日0时0分0秒，换算成北京时间为2014年11月11日8时0分0秒。

* 时间戳
标准北京时间，时区为东八区，自1970年1月1日 0点0分0秒以来的毫秒数。备注：格式13位

* 交易金额
交易金额默认为人民币交易，接口中参数支付金额单位为【分】，参数值不能带小数。

* 货币类型
CNY：人民币

#### 以下为统一返回报文结构

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | number | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### 全局错误码

|    值     | HTTP状态码 |        含义        |                 说明                 |
|-----------|------------|--------------------|--------------------------------------|
| 1000      | 200        | 调用成功           |                                      |
| 1001      | 200        | 非法参数           | 请求的参数不符合所调用的API的要求    |
| 1002      | 200        | 内部服务器错误     | 平台系统内部错误，请联系平台技术支持 |
| 1003      | 200        | 解析JSON字符串失败 | 无法解析请求中提交的JSON字符串       |
| 1004/1005 | 200/401    | Token无效          | 请求中包含的Token无效或过期          |
| 1004/1005 | 200/401    | Token不能为空      | 认证以为的API调用，必须包含Token     |

## 二、签名认证

用户在接入平台Openapi前，需要通过平台的签名认证，通过认证成功后返回的token才能顺利调用平台提供给用户的接口。

### 签名步骤：
1. 首先对需要签名的数据进行字典排序
2. 将排序后的数据拼成字符串
3. 用私钥将字符串进行RSA-SHA1签名
4. 将生成的签名再进行Base64计算

#### 参考示例：

java版步骤如下

1、用户将接入准备完成后将获取到的key值与当前请求时间戳timestamp进行字典序排序，并将排序结果拼接成排序字符串 A。


排序示例（java版）
```java
    //封装排序参数
    string A = "";
    Map<string, Object> signDataMap = new HashMap();
    signDataMap.put("key", docKey);
    signDataMap.put("timestamp", timestamp);
    //加入List用Collections的sort方法排序
    List<string> keys = new ArrayList<>(signDataMap.keySet());
    Collections.sort(keys);
    for (string key : keys) {
        A += signDataMap.get(key);
    }
```

2、用户取得排序后的字符串A所对应的**Hash值**，即字符串B

取Hash值示例（java版）
```java
    //定义字典字符串和Hash值对象
   string A = "";
   string B = "";
   try {
        final MessageDigest mDigest = MessageDigest.getInstance("SHA1");
        mDigest.update(A.getBytes());
        B = bytesToHexstring(mDigest.digest());
    } catch (NoSuchAlgorithmException e) {
        B = string.valueOf(A.hashCode());
    }
```

3、用户使用接入准备中生成的私钥对Hash值进行RSA2加密，并对其进行Base64编码即能成为[签名认证](#签名认证协议)接口中的sign参数。RSA2加密请参见[加密算法](http://blog.csdn.net/u010837811/article/details/51541911)。

4、进行base64编码

## 三、API接口

### 备注说明

1、除签名验证协议`https://api.best-seeing.com/v1.0/auth/token`以外，用户在访问任何接口协议时必须要在Http**请求头**里面加入**Token信息**

#### 参考示例

```
Accept:*/*
Accept-Encoding:gzip, deflate
Accept-Language:zh-CN,zh;q=0.8
token: 2597318629358407
Content-Type: application/json
Cache-Control: no-cache
```

2、对于 **PUT、DELETE、GET** 三种类型的单一资源对象的HTTP请求操作，请求操作的资源对象ID以URL中的**Path路径表示**。


## 四、基础接口

### 签名认证协议

#### 简要描述：

此协议是租户或第三方平台接入医疗平台API所必要的身份校验。通过校验后的用户可以获取认证token，继而正常使用医疗平台提供的各项API服务。

#### 使用说明：

1. 用户需要将公钥上传到医疗平台，上传成功会获取到该公钥对应的key值。
2. 用户根据协议提供接口必需的请求参数，包括业务参数和签名数据。签名算法详见 [签名算法](#二、签名认证)。

#### 请求URL：

- https://api.best-seeing.com/v1.0/auth/token

#### 请求方式：

- POST 

#### 请求参数说明：

| 参数名    | 必选 | 类型   | 说明                                                  |
| --------- | ---- | ------ | ----------------------------------------------------- |
| key       | 是   | string | 租户与平台对接key，由平台分配                         |
| algorithm | 否   | string | 加密算法类型，目前仅支持RSA2，传 "RSA"                |
| sign      | 是   | string | 签名数据，对key和timestamp以及algorithm进行签名       |
| timestamp | 是   | long   | 请求时间戳，服务器只处理时间戳在当前时间1分钟内的请求 |

#### 返回参数说明：

| 参数名 | 类型   | 说明     |
| ------ | ------ | -------- |
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

data对象

| 参数名  |  类型  |                 说明                 |
|---------|--------|--------------------------------------|
| token   | string | 授权token                            |
| expires | long   | token过期时间，截止该时间则token失效 |

#### 返回示例

```java
{
  "code":1000,
  "msg":"调用成功",
  "data":{"token":"334081f8-dc24-4b15-be1a-127e06172046", "expires":259200}
}
```

#### 错误码

|  值  | HTTP状态码 |        含义        |                             说明                            |
|------|------------|--------------------|-------------------------------------------------------------|
| 2001 |        200 | 找不到租户         | key对应的租户拥有者不存在或已失效                           |
| 2002 |        200 | 找不到租户对接信息 | key对应的授权记录不存在                                     |
| 2003 |        200 | 加密算法不支持     | 签名的算法不在平台的支持列表中                              |
| 2004 |        200 | 用户签名不正确     | 请求的sign签名参数可能为空或者格式有误                      |
| 2005 |        200 | 时间戳有误         | 请求时间戳验证了请求的时效性，时间戳在1分钟内的请求方为有效 |

#### 备注

- 更多返回错误代码请看首页的错误代码描述

## 自助设备管理协议内容

### 自助机注册协议

```url
[POST]/device/manage/atm/register
```

说明：
1. 由WEB页面把自助机注册到服务端上。
2. 根据注册的设备生成对应的开发者账号

#### 请求报文参数

| 参数名          | 类型   | 长度 | 必填 | 说明               |
| --------------- | ------ | ---- | ---- | ------------------ |
| atm_code        | String | 64   | 是   | 自助机标识         |
| atm_mac        | String | 64   | 是   | 自助机MAC地址         |
| atm_name        | String | 64   | 是   | 自助机名称         |
| atm_place       | String | 64   | 否   | 自助机所处位置     |
| atm_factory     | String | 200  | 是   | 自助机设备厂商     |
| atm_create_time | String | 20   | 是   | 自助机出厂日期时间 |
| atm_memo        | String | 200  | 是   | 自助机备注         |

#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| atm_id | String | 自助机后台ID |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7001 | 200        | 自助机已注册 |




### 自助机状态上报协议

```url
[POST]/device/atm/status
```

说明：
1. 上报自助机的状态，说明自己还活着，或是有什么情况。
2. 如果这台自助机未注册的，那么出错打回。
3. 本协议请务必定时调用，建议调用间隔时间为1分钟。

#### 请求报文参数

| 参数名         | 类型   | 长度 | 必填 | 说明                                                         |
| -------------- | ------ | ---- | ---- | ------------------------------------------------------------ |
| atm_code       | String | 64   | 是   | 自助机标识，请保证它每台自助机上都是唯一的，如果多台自助机使用同个标识将会出现物品混乱 |
| atm_host       | String | 32   | 否   | 自助机IP地址                                                 |
| atm_memory     | Long   |      | 否   | 自助机总内存大小，MB                                         |
| atm_use_memory | Long   |      | 否   | 自助机内存使用情况，MB                                       |
| atm_disk       | Long   |      | 否   | 自助机总硬盘大小，GB                                         |
| atm_use_disk   | Long   |      | 否   | 自助机硬盘使用情况，GB                                       |
| atm_timestamp  | Long   |      | 是   | 自助机当前系统时间，毫秒                                     |
| atm_state      | String | 8    | 是   | 自助机当前状态码，0:正常，其它值表示异常或其它情况，具体见状态信息 |
| atm_message    | String | 64   | 否   | 自助机当前状态信息                                           |


#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| server_timestamp | Long| 服务器时间 |
| atm_restart | Integer | 是否需要重启标志：0:不需要,1:需要(状态上报连续10次都不正常就需要重启) |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |


## 自助机服务协议


### 自助机启用禁用协议

```url
[POST]/device/manage/atm/enable
```

说明：
1. 自助机添加商品的时候调用该协议，将自助机禁用
2. 自助机添加商品完成的时候将现有库存信息提交进行平台数据矫正

#### 请求报文参数

| 参数名     | 类型    | 必填 | 说明           |
| ---------- | ------- | ---- | -------------- |
| atm_id     | String  | 是   | 自助机后台ID   |
| atm_enable | Integer | 是   | 1-可用，0-禁用 |
| ship_goods     | ObjectList |      否   | 当前商品列表 |
| ship_timestamp | String     |      是   | 当前时间     |

##### 商品列表

| 参数名      | 类型    | 长度 | 必填 | 说明       |
| ----------- | ------- | ---- | ---- | ---------- |
| goods_id    | String  |      | 是   | 商品ID     |
| goods_place | String  | 8    | 是   | 商品位置   |
| goods_num   | Integer |      | 是   | 商品总数量 |

#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：

| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| atm_id | String  | 自助机后台ID |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |
| 7011 | 200        | 自助机商品ID和位置错误 |
| 7013 | 200        | 商品ID不存在 |

### 自助机处方订单扫描接口

```url
[POST]/device/manage/atm/prescription/scan
```
说明：
1. 订单状态为1时，可直接调用支付协议进行支付
2. 订单状态为2时，可以直接出货
3. 订单状态为3时，提示用户该订单已提货
4. 订单状态为4时，提示用户该订单已失效

#### 请求报文参数

| 参数名      | 类型   | 长度 | 必填 | 说明                       |
| ----------- | ------ | ---- | ---- | -------------------------- |
| atm_id      | String | 64   | 是   | 自助机后台ID               |
| trade_id    | String |      | 是   | 订单ID（只支持当天的订单） |


#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| trade_state   | Integer     | 订单状态1:等待付款；2:待提货；3:交易成功;4:交易已关闭 |
| ship_buyer_id | String        | 出货人ID                                                     |
| ship_buyer    | String       | 出货人姓名                                                   |
| ship_goods    | ObjectList   |                                                              |

##### 商品列表

| 参数名    | 类型      | 说明     |
| --------- | -------   | -------- |
| goods_id  | String     | 商品ID   |
| goods_num | Integer   | 出库数量 |
| goods_place | String    | 商品位置   |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |
| 7003 | 200        | 自助机已停售 |
| 7010 | 200        | 无此订单信息 |
| 7012 | 200        | 订单商品库存数量不够 |

### 自助机处方订单支付接口

```url
[POST]/device/manage/atm/prescription/pay
```

#### 请求报文参数

| 参数名   | 类型   | 长度 | 必填 | 说明                          |
| -------- | ------ | ---- | ---- | ----------------------------- |
| atm_id   | String | 64   | 是   | 自助机后台ID                  |
| trade_id | String |      | 是   | 订单ID（只支持当天的订单）    |
| qrcode   | String |      | 是   | 对于支付宝或微信支付 需要该值 |
| pay_channel | String |      | 是   | 渠道id(0:支付宝,1:微信)                   |

#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| pay_state | Integer    | 收费状态:1-支付成功;2-等待支付;3-支付失败;4-未知异常 |
| char_id   | String    | 结算单ID                                             |
| pay_msg   | String     | 支付返回信息                                         |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |
| 7003 | 200        | 自助机已停售 |
| 7010 | 200        | 无此订单信息 |


### 自助机出货确认

```url
[POST]/device/atm/shipment
```

说明:
1. 通知服务端，物品已经离开自助机，服务端进行库存的出库操作。
2. 每次出库同时核对剩余库存量

#### 请求报文参数

| 参数名         | 类型       | 长度 | 必填 | 说明                       |
| -------------- | ---------- | ---- | ---- | -------------------------- |
| atm_id         | String     | 64   | 是   | 自助机标识                 |
| trade_id       | String     |      | 是   | 订单ID（只支持当天的订单） |
| ship_buyer_id  | String     |      | 是   | 出货人                     |
| ship_reason    | String     |      | 否   | 出货事项                   |
| ship_goods     | ObjectList |      | 是   | 出货商品列表               |
| ship_timestamp | Long       |      | 是   | 出货时间                   |

##### 商品列表

| 参数名      | 类型    | 长度 | 必填 | 说明     |
| ----------- | ------- | ---- | ---- | -------- |
| goods_id    | String  |      | 是   | 商品ID   |
| goods_place | String  | 8    | 是   | 商品位置 |
| goods_num   | Integer |      | 是   | 出货数量 |
| goods_count | Integer |      | 是   | 剩余数量 |

#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
|||

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |
| 7003 | 200        | 自助机已停售 |
| 7010 | 200        | 无此订单信息 |
| 7013 | 200        | 商品ID不存在 |

### 自助机物品取消出库协议

说明：

1. 通知服务端，物品未离开自助机，服务端进行库存的入库操作
2. 核对入库后的库存数量

```url
[POST]/device/manage/atm/cancel_shipment
```

#### 请求报文参数

| 参数名     | 类型       | 长度 | 必填 | 说明                       |
| ---------- | ---------- | ---- | ---- | -------------------------- |
| atm_id     | String     | 64   | 是   | 自助机后台ID               |
| trade_id   | String     |      | 是   | 订单ID（只支持当天的订单） |
| ship_goods | ObjectList |      | 是   | 出库商品列表               |

##### 商品列表

| 参数名      | 类型    | 长度 | 必填 | 说明     |
| ----------- | ------- | ---- | ---- | -------- |
| goods_id    | String  |      | 是   | 商品ID   |
| goods_place | String  | 8    | 是   | 商品位置 |
| goods_num   | Integer |      | 是   | 出货数量 |
| goods_count | Integer |      | 是   | 剩余数量 |

#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| cancel_state | Integer   | 返回取消结果 0-失败 1-成功 |
| cancel_msg   | String  | 失败原因                   |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |
| 7003 | 200        | 自助机已停售 |
| 7010 | 200        | 无此订单信息 |
| 7013 | 200        | 商品ID不存在 |

### 错误信息上报

```url
[POST]/device/manage/atm/error_report
```

#### 请求报文参数

| 参数名          | 类型   | 长度 | 必填 | 说明         |
| --------------- | ------ | ---- | ---- | ------------ |
| atm_id          | String | 64   | 是   | 自助机后台ID |
| error_msg       | String |      | 是   | 错误信息     |
| error_timestamp | String |      | 是   | 错误时间     |

#### 返回参数说明：

| 参数名 |  类型  |   说明   |
|--------|--------|----------|
| code   | string | 状态码   |
| msg    | string | 状态信息 |
| data   | object | 返回数据 |

#### data参数说明：


| 参数名 | 类型   | 说明         |
| ------ | ------ | ------------ |
| 无     |      |      |

#### 错误码

| 值   | HTTP状态码 | 说明         |
| ---- | ---------- | ------------ |
| 7002 | 200        | 自助机未注册 |