# 搜索服务协议

## 基本信息

端口号：8013
RedisDB：7
支持大批量数据的模糊查询功能，使用Elasticsearch引擎实现。

基于6.3.0版本的Elasticsearch

## Elasticsearch索引设计

### 插件

* [pinyin](https://github.com/medcl/elasticsearch-analysis-pinyin)
* [ik](https://github.com/medcl/elasticsearch-analysis-ik)

### 患者信息索引

#### 索引结构

```sh
curl -XPUT http://192.68.75.24:9200/patient_info_v1 -H 'Content-Type:application/json' -d'
{
    "settings":{
        "analysis":{
            "analyzer":{
                "pinyin_analyzer":{
                    "tokenizer":"my_pinyin"
                },
                "first_letter_pinyin_analyzer":{
                    "tokenizer":"my_first_letter_pinyin"
                },
                "first_letter_pinyin_none_number_analyzer":{
                    "tokenizer":"my_first_letter_pinyin_none_number"
                },
                "my_full_pinyin":{
                    "tokenizer":"my_full_pinyin"
                }
            },
            "tokenizer":{
                "my_pinyin":{
                    "type":"pinyin",
                    "keep_first_letter":true,
                    "keep_separate_first_letter":true,
                    "keep_none_chinese_in_first_letter":true,
                    "keep_none_chinese":false,
                    "keep_full_pinyin":false,
                    "keep_original":false,
                    "lowercase":true
                },
                "my_first_letter_pinyin":{
                    "type":"pinyin",
                    "keep_first_letter":true,
                    "keep_separate_first_letter":false,
                    "keep_none_chinese":false,
                    "keep_none_chinese_in_joined_full_pinyin":true,
                    "none_chinese_pinyin_tokenize":false,
                    "keep_full_pinyin":false,
                    "keep_original":false,
                    "trim_whitespace":false,
                    "lowercase":true
                },
                "my_first_letter_pinyin_none_number":{
                    "type":"pinyin",
                    "keep_first_letter":true,
                    "keep_separate_first_letter":false,
                    "keep_none_chinese":false,
                    "keep_none_chinese_in_first_letter":false,
                    "keep_none_chinese_in_joined_full_pinyin":false,
                    "none_chinese_pinyin_tokenize":false,
                    "keep_full_pinyin":false,
                    "keep_original":false,
                    "trim_whitespace":false,
                    "lowercase":true
                },
                "my_full_pinyin":{
                    "type":"pinyin",
                    "keep_first_letter":false,
                    "keep_joined_full_pinyin":true,
                    "keep_separate_first_letter":false,
                    "keep_none_chinese":false,
                    "keep_none_chinese_in_joined_full_pinyin":true,
                    "none_chinese_pinyin_tokenize":false,
                    "keep_full_pinyin":false,
                    "keep_original":false,
                    "trim_whitespace":false,
                    "lowercase":true
                }
            }
        }
    },
    "mappings":{
        "info":{
            "properties":{
                "pati_name":{
                    "type":"text",
                    "fields":{
                        "pinyin":{
                            "type":"text",
                            "store":false,
                            "analyzer":"pinyin_analyzer"
                        },
                        "ik":{
                            "type":"text",
                            "store":false,
                            "analyzer":"ik_max_word"
                        },
                "name":{
                    "type":"text",
                    "store":false,
                    "fielddata":true,
                    "analyzer":"keyword"
                },
                        "py_none_number":{
                            "type":"text",
                            "store":false,
                            "fielddata":true,
                            "analyzer":"first_letter_pinyin_none_number_analyzer"
                        },
                        "py":{
                            "type":"text",
                            "store":false,
                            "fielddata":true,
                            "analyzer":"first_letter_pinyin_analyzer"
                        },
                        "full_pinyin":{
                            "type":"text",
                            "store":false,
                            "fielddata":true,
                            "analyzer":"my_full_pinyin"
                        }
                    }
                },
                "pati_gender":{
                    "type":"byte"
                },
                "pati_cost_type":{
                    "type":"byte"
                },
                "trea_info":{
                    "type":"text"
                },
                "trea_id":{
                    "type":"long"
                },
                "tena_id":{
                    "type":"long"
                },
                "trea_time_list":{
                    "type":"text",
                    "fielddata":true,
                    "fields":{
                        "ik":{
                            "type":"text",
                            "store":false,
                            "analyzer":"ik_smart"
                        }
                    }
                },
                "pati_label_name":{
                    "type":"text",
                    "fields":{
                        "ik":{
                            "type":"text",
                            "store":false,
                            "analyzer":"ik_smart"
                        }
                    }
                }
            }
        }
    }
}
'
```

#### 别名创建

```sh
curl -X POST http://192.68.75.24:9200/_aliases -H 'Content-Type:application/json'  -d '
{
    "actions":[
        {
            "remove":{
                "alias":"patient_info",
                "index":"patient_info_v2"
            }
        },
        {
            "add":{
                "alias":"patient_info",
                "index":"patient_info_v1"
            }
        }
    ]
}
'
```

#### 更改搜索最大值

```
curl -XPUT http://192.68.75.24:9200/patient_info/_settings -H 'Content-Type:application/json' -d'
{
  "index.max_result_window" : "5000000"
}
'
```

## 更新mapping

```sh
curl -XPUT http://192.68.75.24:9200/patient_info/_mapping/info -H 'Content-Type:application/json' -d'
{
    "properties":{
        "pati_label_name":{
            "type":"text",
            "fields":{
                "ik":{
                    "type":"text",
                    "store":false,
                    "analyzer":"ik_smart"
                }
            }
        }
    }
}
'
```

### 如果更新mapping后不生效（应该是该字段已有数据了）

> 索引需要从新创建出来后，再执行该命令同步数据
> 从新创建新的索引
> source中为老的索引名称，dest中为新的索引名称

```sh
curl -XPOST http://192.68.75.29:9200/_reindex -H 'Content-Type:application/json' -d'
{
  "source": {
    "index": "patient_info_v2"
  },
  "dest": {
    "index": "patient_info_v1"
  }
}
'
```

## 使用自定义score的算法

```sh
{
  "query": {
    "function_score": {
      "script_score": {
        "script": {
          "lang": "painless",
          "params": {
            "mm": "1533830400"
          },
          "inline": "long total = 0; for (int i = doc['trea_time_list'].length-1; i >=0; i--) { if(Long.parseLong(doc['trea_time_list'][i])<= Long.parseLong(params.mm)){total=Long.parseLong(doc['trea_time_list'][i]); break;} } return total;"
        }
      }
    }
  }
}
```

## 更新analysis

```sh
curl -XPOST http://192.68.75.24:9200/patient_info/_close -H 'Content-Type:application/json'

curl -XPUT http://192.68.75.24:9200/patient_info/_settings -H 'Content-Type:application/json' -d'
{
    "analysis":{
        "analyzer":{
            "pinyin_analyzer":{
                "tokenizer":"my_pinyin"
            },
            "first_letter_pinyin_analyzer":{
                "tokenizer":"my_first_letter_pinyin"
            },
            "first_letter_pinyin_none_number_analyzer":{
                "tokenizer":"my_first_letter_pinyin_none_number"
            },
            "my_full_pinyin":{
                "tokenizer":"my_full_pinyin"
            }
        },
        "tokenizer":{
            "my_pinyin":{
                "type":"pinyin",
                "keep_first_letter":true,
                "keep_separate_first_letter":true,
                "keep_none_chinese_in_first_letter":true,
                "keep_none_chinese":false,
                "keep_full_pinyin":false,
                "keep_original":false,
                "lowercase":true
            },
            "my_first_letter_pinyin":{
                "type":"pinyin",
                "keep_first_letter":true,
                "keep_separate_first_letter":false,
                "keep_none_chinese":false,
                "keep_none_chinese_in_joined_full_pinyin":true,
                "none_chinese_pinyin_tokenize":false,
                "keep_full_pinyin":false,
                "keep_original":false,
                "trim_whitespace":false,
                "lowercase":true
            },
            "my_first_letter_pinyin_none_number":{
                "type":"pinyin",
                "keep_first_letter":true,
                "keep_separate_first_letter":false,
                "keep_none_chinese":false,
                "keep_none_chinese_in_first_letter":false,
                "keep_none_chinese_in_joined_full_pinyin":false,
                "none_chinese_pinyin_tokenize":false,
                "keep_full_pinyin":false,
                "keep_original":false,
                "trim_whitespace":false,
                "lowercase":true
            },
            "my_full_pinyin":{
                "type":"pinyin",
                "keep_first_letter":false,
                "keep_joined_full_pinyin":true,
                "keep_separate_first_letter":false,
                "keep_none_chinese":false,
                "keep_none_chinese_in_joined_full_pinyin":true,
                "none_chinese_pinyin_tokenize":false,
                "keep_full_pinyin":false,
                "keep_original":false,
                "trim_whitespace":false,
                "lowercase":true
            }
        }
    }
}
'

curl -XPOST http://192.68.75.24:9200/patient_info/_open -H 'Content-Type:application/json'
```

### 使用分析器分析内容

```sh
curl -XPOST http://192.68.75.24:9200/patient_info/_analyze -H 'Content-Type:application/json'
{
  "analyzer": "ik_smart",
  "text": "2018-03-08,2018-08-09,2018-08-10,2018-08-13"
}
'
```

### 精确查询手机号

```sh
curl -XPOST http://192.68.75.24:9200/patient_info/info/_search  -H 'Content-Type:application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "pati_phone.keyword": "Lon0GW5p0SVQ3GME0TEF/QM="
          }
        }
      ]
    }
  }
}
'
```

### 拼音首字母检索

```sh
curl -XPOST http://192.68.75.24:9200/patient_info/info/_search  -H 'Content-Type:application/json' -d'
{
  "query": {
    "prefix": {
      "pati_name.py": "wb"
    }
  },
  "sort": [
    {
      "_score": "desc"
    },
    {
      "pati_name.py": "asc"
    },
    {
      "pati_name.full_pinyin": "asc"
    }
  ],
  "size": 50
}
'
```

### 使用scroll搜索

```sh
curl -XPOST http://192.68.75.24:9200/patient_info/info/_search?scroll=10m  -H 'Content-Type:application/json' -d'
{
  "query": {
    "prefix": {
      "pati_name.py": "w"
    }
  },
  "sort": [
    {
      "_score": "desc"
    },
    {
      "pati_name.py": "asc"
    },
    {
      "pati_name.full_pinyin": "asc"
    }
  ],
  "size": 5000
}
'
```

### 根据scorell_id获取文档内容

```sh
curl -XPOST http://192.68.75.24:9200/_search/scroll -H 'Content-Type:application/json' -d'
{
    "scroll_id":"DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAuWFm9jUUNraDhSUk1leFpjVXV3Q0ZVZkEAAAAAAAALmBZvY1FDa2g4UlJNZXhaY1V1d0NGVWZBAAAAAAAAC5kWb2NRQ2toOFJSTWV4WmNVdXdDRlVmQQAAAAAAAAuaFm9jUUNraDhSUk1leFpjVXV3Q0ZVZkEAAAAAAAALlxZvY1FDa2g4UlJNZXhaY1V1d0NGVWZB",
    "scroll":"1m"
}
'
```

### 查看ES所有索引信息

```sh
curl -XGET http://192.68.75.24:9200/_cat/indices
```

### 索引更新记录

#### 添加标签字段

| 对应版本     | 说明            |
| -------- | ------------- |
| V1.3.9.1 | 添加标签字段 |

```sh
curl -XPUT http://192.68.75.24:9200/patient_info/_mapping/info -H 'Content-Type:application/json' -d'
{
    "properties":{
        "pati_label_name":{
            "type":"text",
            "fields":{
                "ik":{
                    "type":"text",
                    "store":false,
                    "analyzer":"ik_smart"
                }
            }
        }
    }
}
'
```


## 检索患者

### 根据手机号、姓名、首字母获取患者列表

> [GET]/search_service/patients/search

#### 请求头部

| 参数名      | 类型     | 必填   | 长度   | 说明   |
| -------- | ------ | ---- | ---- | ---- |
| tenantId | String | 是    |      | 租户号  |


#### 请求报文参数

| 参数名     | 类型      | 必填   | 长度   | 说明                               |
| ------- | ------- | ---- | ---- | -------------------------------- |
| key     | String  | 否    |      | 手机号、姓名、首字母（手机号全匹配、姓名模糊匹配、首字母左匹配） |
| pati_id | Integer | 否    |      | 患者ID                             |



#### 回复报文参数ObjectList

| 参数名                 | 类型     | 说明                |
| ------------------- | ------ | ----------------- |
| pati_id             | Long   | 患者ID              |
| pati_name           | String | 姓名                |
| pati_gender         | String | 性别代码 0 未知 1男  2 女 |
| pati_age            | String | 年龄                |
| pati_birthday       | Date   | 出生年月              |
| pati_phone          | String | 手机号码              |
| pati_id_number      | String | 身份证               |
| pati_address        | String | 地址                |
| pati_splice_address | String | 详细地址              |
| pati_py             | String | 拼音首字母             |

### 批量添加或者更新某个患者文档信息

> [POST]/search_service/patients

#### 请求头部

| 参数名      | 类型     | 必填   | 长度   | 说明   |
| -------- | ------ | ---- | ---- | ---- |
| tenantId | String | 是    |      | 租户号  |

#### 请求报文参数 ObjectList

| 参数名                 | 类型       | 必填   | 长度   | 说明                |
| ------------------- | -------- | ---- | ---- | ----------------- |
| pati_id             | Long     | 是    |      | 患者ID              |
| pati_name           | String   | 是    |      | 姓名                |
| pati_gender         | String   | 是    |      | 性别代码 0 未知 1男  2 女 |
| pati_age            | String   | 是    |      | 年龄                |
| pati_birthday       | Date     | 是    |      | 出生年月              |
| pati_phone          | String   | 是    |      | 手机号码              |
| pati_id_number      | String   | 是    |      | 身份证               |
| pati_address        | String   | 是    |      | 地址                |
| pati_splice_address | String   | 是    |      | 详细地址              |
| pati_py             | String   | 是    |      | 拼音首字母             |
| trea_time_list      | String[] | 是    |      | 患者就诊信息数组          |
| trea_id             | String   | 是    |      | 最后一次就诊ID          |


### 添加或者更新某个患者文档信息

> [POST]/search_service/patients/{pati_id}

#### 请求头部

| 参数名      | 类型     | 必填   | 长度   | 说明   |
| -------- | ------ | ---- | ---- | ---- |
| tenantId | String | 是    |      | 租户号  |

#### 请求报文参数

| 参数名                 | 类型       | 必填   | 长度   | 说明                |
| ------------------- | -------- | ---- | ---- | ----------------- |
| pati_name           | String   | 是    |      | 姓名                |
| pati_gender         | String   | 是    |      | 性别代码 0 未知 1男  2 女 |
| pati_age            | String   | 是    |      | 年龄                |
| pati_birthday       | Date     | 是    |      | 出生年月              |
| pati_phone          | String   | 是    |      | 手机号码              |
| pati_id_number      | String   | 是    |      | 身份证               |
| pati_address        | String   | 是    |      | 地址                |
| pati_splice_address | String   | 是    |      | 详细地址              |
| pati_py             | String   | 是    |      | 拼音首字母             |
| trea_time_list      | String[] | 是    |      | 患者就诊信息数组          |
| trea_id             | String   | 是    |      | 最后一次就诊ID          |


#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |

### 删除某个患者文档信息

> [DELETE]/search_service/patients/{pati_id}

#### 请求头部

| 参数名      | 类型     | 必填   | 长度   | 说明   |
| -------- | ------ | ---- | ---- | ---- |
| tenantId | String | 是    |      | 租户号  |

#### 请求报文参数

| 参数名     | 类型     | 必填   | 长度   | 说明   |
| ------- | ------ | ---- | ---- | ---- |
| pati_id | String | 是    |      | 患者ID |



#### 回复报文参数

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |

### 获取某个患者文档信息

> [GET]/search_service/patients/{pati_id}

| 参数名      | 类型     | 必填   | 长度   | 说明   |
| -------- | ------ | ---- | ---- | ---- |
| tenantId | String | 是    |      | 租户号  |

#### 请求报文参数

| 参数名     | 类型     | 必填   | 长度   | 说明   |
| ------- | ------ | ---- | ---- | ---- |
| pati_id | String | 是    |      | 患者ID |


#### 回复报文参数

| 参数名                 | 类型     | 说明                |
| ------------------- | ------ | ----------------- |
| pati_id             | String | 患者ID              |
| pati_name           | String | 姓名                |
| pati_gender         | String | 性别代码 0 未知 1男  2 女 |
| pati_age            | String | 年龄                |
| pati_birthday       | Date   | 出生年月              |
| pati_phone          | String | 手机号码              |
| pati_id_number      | String | 身份证               |
| pati_address        | String | 地址                |
| pati_splice_address | String | 全地址               |
| pati_py             | String | 拼音首字母             |
| trea_id             | String | 就诊ID              |



### 患者信息查询

```
 [GET]/search_service/treatment/patients
```

####修改更新记录

| 对应版本     | 说明             |
| -------- | -------------- |
| V1.3.3.1 | 新增 患者信息查询      |
| V1.3.9.1 | 修改 新增分组和标签2个字段 |

#### 请求报文参数

| 参数名               | 类型      | 必填   | 说明               |
| ----------------- | ------- | ---- | ---------------- |
| key               | String  | 否    | 姓名、手机号或身份证       |
| gender            | Integer | 否    | 1:男，2:女，不传或者0为全部 |
| birthday_start    | String  | 否    | 出生日期开始日期         |
| birthday_end      | String  | 否    | 出生日期结束日期         |
| create_time_start | String  | 否    | 建档日期开始日期         |
| create_time_end   | String  | 否    | 建档日期结束日期         |
| trea_time_start   | String  | 否    | 就诊日期开始日期         |
| trea_time_end     | String  | 否    | 就诊日期结束日期         |
| page_size         | Integer | 否    | 每页条数 空表示10条      |
| page_num          | Integer | 否    | 第几页 空表示第1页       |
| pati_group         | String | 否    | 分组 为空查全部     |
| pati_label          | String | 否    | 标签 为空查全部      |
#### 回复报文参数Object

| 参数名       | 类型         | 必填   | 说明     |
| --------- | ---------- | ---- | ------ |
| page_num  | Integer    | 是    | 当前页    |
| page_size | Integer    | 是    | 每页的数量  |
| total     | Integer    | 是    | 总记录数   |
| pages     | Integer    | 是    | 总页数    |
| list      | ObjectList | 否    | 患者信息列表 |

患者信息列表

| 参数名            | 类型      | 必填   | 说明       |
| -------------- | ------- | ---- | -------- |
| pati_id        | String  | 是    | 患者ID     |
| pati_name      | String  | 是    | 患者姓名     |
| pati_gender    | String  | 是    | 1:男，2:女  |
| pati_age       | String  | 是    | 患者年龄     |
| pati_phone     | Integer | 是    | 患者手机号    |
| pati_id_number | String  | 是    | 患者身份证号   |
| create_time    | String  | 是    | 建档日期     |
| trea_time      | String  | 是    | 最后就诊日期   |
| trea_id        | String  | 是    | 最后一次就诊ID |
| pati_group     | String  | 是    | 分组       |
| pati_label     | String  | 是    | 标签       |

## 同步设计

### 患者信息同步

使用mq-redis的功能同步，同步队列名：ES_PATIENT_INFO    RedisDB：7

## 协议内容


## 涉及更改内容


> <b>web</b>

### 注册患者信息（建档）

联系人关系  证件号类型类型 前端页面写死

> [POST]/patient_service/patient

#### 请求报文参数

| 参数名            | 类型      | 必填   | 说明                |
| -------------- | ------- | ---- | ----------------- |
| pati_name      | String  | 是    | 姓名                |
| pati_gender    | String  | 是    | 性别代码 0 未知 1男  2 女 |
| pati_birthday  | Date    | 是    | 出生年月              |
| pati_phone     | String  | 是    | 手机号码              |
| pati_id_type   | String  | 否    | 证件类型 99 身份证       |
| pati_id_number | String  | 否    | 证件号码              |
| pati_province  | String  | 否    | 省                 |
| pati_city      | String  | 否    | 市                 |
| pati_county    | String  | 否    | 区县                |
| pati_address   | String  | 否    | 详细地址              |
| cont_name      | String  | 否    | 联系人               |
| cont_relation  | Integer | 否    | 关系                |
| cont_phone     | String  | 否    | 联系人电话             |

#### 回复报文参数Object

| 参数名     | 类型   | 必填   | 说明   |
| ------- | ---- | ---- | ---- |
| pati_id | Long | 是    | 患者ID |


### 修改患者信息（建档）

> [POST]/patient_service/patient/update

#### 请求报文参数

| 参数名            | 类型      | 必填   | 说明                |
| -------------- | ------- | ---- | ----------------- |
| pati_id        | Long    | 是    | 患者ID              |
| pati_name      | String  | 是    | 姓名                |
| pati_gender    | String  | 是    | 性别代码 0 未知 1男  2 女 |
| pati_birthday  | Date    | 是    | 出生年月              |
| pati_phone     | String  | 是    | 手机号码              |
| pati_id_type   | String  | 否    | 证件类型 99 身份证       |
| pati_id_number | String  | 否    | 证件号码              |
| pati_province  | String  | 否    | 省                 |
| pati_city      | String  | 否    | 市                 |
| pati_county    | String  | 否    | 区县                |
| pati_address   | String  | 否    | 详细地址              |
| cont_name      | String  | 否    | 联系人               |
| cont_relation  | Integer | 否    | 关系                |
| cont_phone     | String  | 否    | 联系人电话             |

#### 回复报文参数Object

| 参数名  | 类型   | 必填   | 说明   |
| ---- | ---- | ---- | ---- |
| 无    |      |      |      |


预约挂号是否也有相关内容?



> <b>public</b>


###  新建就诊人协议（建档） 

```url
[POST]/outpatient/patient
```

说明：
1. 如果姓名+手机号码在租户内重复，就认为这个就诊人存在。
2. 如果身份证存在时，姓名+身份证号在租户内重复，就认为这个就诊人存在。

#### 修改更新记录

| 对应业务      | 说明   |
| --------- | ---- |
| APPV1.0.2 | 新增   |

#### 请求报文参数

| 参数名       | 类型      | 必填   | 说明                          |
| --------- | ------- | ---- | --------------------------- |
| tenant_id | Long    | 是    | 租户ID                        |
| name      | String  | 是    | 就诊人姓名                       |
| gender    | Integer | 是    | 性别:0-未知;1-男;2-女;9-未规定项（未指明） |
| birthdate | String  | 是    | 出生年月,格式yyyy-MM-dd           |
| phone     | String  | 是    | 手机号                         |
| idno      | String  | 否    | 身份证号                        |
| county    | String  | 否    | 所在区域，国标六位数                  |
| address   | String  | 否    | 详细地址                        |

#### 回复报文参数

| 参数名        | 类型   | 必填   | 说明   |
| ---------- | ---- | ---- | ---- |
| patient_id | Long | 是    | 患者ID |


> <b>API</b>

患者同步新增和修改
EmrService patientRelate